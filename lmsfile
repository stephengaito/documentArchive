-- A Lua Make System file

testProbe = directorySeparator..'test'
-- dirsToIgnore = '|archive|tmp|installDir|tex|bin|'
dirsToIgnore = '|archive|tmp|installDir|bin|'

function findReleaseFiles(dir, filesIO)
  local dirList = { }
  for anEntry in lfs.dir(dir) do
    table.insert(dirList, anEntry)
  end
  table.sort(dirList)
  for i, anEntry in ipairs(dirList) do
    if  not anEntry:find('^%.')
    and not dirsToIgnore:find(anEntry, 1, true)
    then
      fullPath = makePath{dir, anEntry}
      if lfs.attributes(fullPath, 'mode') == 'directory' then
        findReleaseFiles(fullPath, filesIO)
      else
        if string.find(fullPath, '%.tex$')
        or string.find(fullPath, '%.mkiv$')
        or string.find(fullPath, '%.lua$')
        or string.find(fullPath, '%.c$')
        or string.find(fullPath, '%.h$')
        or string.find(fullPath, testProbe)
        or string.find(fullPath, 'lmsfile$')
        then
          filesIO:write(fullPath..'\n')
        end
      end
    end
  end
end

function createReleaseFile()
  lfs.mkdir('releases')

  local gitHead = io.open('.git/refs/heads/master')
  local shortHash = gitHead:read(7)
  gitHead:close()
  local releaseName = makePath{
    'releases',
    'release-'..os.date('%F')..'-'..shortHash..'.tar.gz'
  }

  local filesIOName = os.tmpname()
  local filesIO = io.open(filesIOName, 'w')
  findReleaseFiles('.', filesIO)
  filesIO:close()

  os.execute('tar czvf '..releaseName..' -T '..filesIOName)

  os.remove(filesIOName)
end

if clearScreen then os.execute('reset') end

cmd = 'lms'
if 0 < #arg then
  arguments = table.concat(arg, ' ')
  if arguments == 'release' then
    createReleaseFile()
    os.exit(0)
  end
  cmd = 'lms -c '..arguments
end

lfs = require 'lfs'

subDirs = {
  'module',
  'base',
  'extensions',
  'core'
}

curDir = lfs.currentdir()
for i, subDir in ipairs(subDirs) do
  print('\n========================================================')
  print('working in ['..subDir..']')
  print('running    ['..cmd..']')
  lfs.chdir(subDir)
  if not os.execute(cmd) then
    print('FAILED to run: ['..cmd..']')
    os.exit(-1)
  end
  lfs.chdir(curDir)
end

os.exit(0)
