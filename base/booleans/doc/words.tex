% A ConTeXt document [master document: booleans.tex]

\section[title=Words]

%\startWord[isBoolean]

\startRule[isBoolean]
\preDataStack
  (
    top : aType
    dataStack
  )
\preProcessStack
  (
    processStack
  )
\postDataStack
  ( (top isBoolean) ->
    TRUE : Boolean
    dataStack
  )
  (else) ->
    FALSE: Boolean
    dataStack
  )
\postProcessStack
  (
    processStack
  )
\stopRule

\startCCode
static void isBooleanAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top);
  JObj* result = NULL;
  if (isBoolean(top))
    result = newBoolean(jInterp, TRUE);
  else
    result = newBoolean(jInterp, FALSE);
  pushCtxData(aCtx, result);
}
\stopCCode

%\stopWord

\startCCode
static void ifteAP(ContextObj* aCtx) {
  popCtxDataInto(aCtx, topElse);
  popCtxDataInto(aCtx, topThen);
  popCtxDataInto(aCtx, topIf);
  pushCtxProcess(aCtx, topElse); // save for later
  pushCtxProcess(aCtx, topThen); // save for later
  pushSymbolCtxProcess(aCtx, "ifteCont");
  prependListCtxProcess(aCtx, topIf); // execute the if condition
}
\stopCCode

\startRule[ifte]
\preDataStack
  (
    topElse : list
    topThen : list
    topIf   : list
    dataStack
  )
\preProcessStack
  (
    processStack
  )
\preConditions
  (topIf isFinite)
\postDataStack
  (
    dataStack
  )
\postProcessStack
  (
    topIf (prepended)
    'ifteCont' : Symbol
    topThen    : list
    topElse    : list
    processStack
  )
\postConditions
\stopRule

\startCCode
static void ifteContAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, topIf);
  popCtxProcessInto(aCtx, topThen);
  popCtxProcessInto(aCtx, topElse);
  if (isTrue(jInterp, topIf)) {
    prependListCtxProcess(aCtx, topThen);
  } else {
    prependListCtxProcess(aCtx, topElse);
  }
}
\stopCCode

\startRule[ifteCont]
\preDataStack
  (
    topIf : Boolean
    dataStack
  )
\preProcessStack
  (
    topThen : list
    topElse : list
    processStack
  )
\preConditions
  (topThen isFinite)
  (topElse isFinite)
\postDataStack
  (
    dataStack
  )
\postProcessStack
  (topIf isTrue) -> (
    topThen (prepended)
    processStack
  )
  OR
  (else) -> (
    topElse (prepended)
    processStack
  )
\postConditions
\stopRule

\setCHeaderStream{private}
\startCHeader
extern void registerBooleanWords(
  JoyLoLInterp* jInterp
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
void registerBooleanWords(
  JoyLoLInterp* jInterp
) {
  assert(jInterp);

  DictObj* true  = createSymbol(jInterp, "true");
  true->value    = newBoolean(jInterp, TRUE);

  DictObj* false = createSymbol(jInterp, "false");
  false->value   = newBoolean(jInterp, FALSE);

  extendJoyLoL(jInterp, "isBoolean", isBooleanAP);
  extendJoyLoL(jInterp, "ifte",      ifteAP);
  extendJoyLoL(jInterp, "ifteCont",  ifteContAP);
}
\stopCCode
