% A ConTeXt document [master document: booleans.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\component gitVersion-c

\startTestSuite[newBoolean]

\startCHeader
extern CoAlgObj* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean);

#define BOOLEAN_FLAG_MASK 0x8L

#define asBoolean(aLoL) (((aLoL)->flags) & BOOLEAN_FLAG_MASK)
\stopCHeader

\startCCode
CoAlgObj* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgObj* result = newObject(jInterp, BooleansTag);
  assert(result);
  
  result->type  = jInterp->coAlgs[BooleansTag].sClass;
  if (aBoolean) {
    result->flags |= BOOLEAN_FLAG_MASK;
  } else {
    result->flags &= ~BOOLEAN_FLAG_MASK;
  }
  return result;
}
\stopCCode

\startTestCase[should create a new boolean]

\startCTest
  AssertPtrNotNull(jInterp);

  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  AssertPtrNotNull(asType(aNewBoolean));
  AssertIntEquals(asTag(aNewBoolean), BooleansTag);
  AssertIntTrue(asFlags(aNewBoolean));
  AssertIntTrue(isAtom(aNewBoolean));
  AssertIntTrue(isBoolean(aNewBoolean));
  AssertIntFalse(isPair(aNewBoolean));
\stopCTest
\stopTestCase

\startTestCase[print Boolean]
\startCTest
  AssertPtrNotNull(jInterp);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);

  CoAlgObj* aLoL = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aLoL);
  printLoLDebug(aStrBuf, aLoL, FALSE);
  AssertStrEquals(getCString(aStrBuf), "true ");
  strBufClose(aStrBuf);

  aLoL = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aLoL);
  printLoLDebug(aStrBuf, aLoL, FALSE);
  AssertStrEquals(getCString(aStrBuf), "false ");
  strBufClose(aStrBuf);
\stopCTest
\stopTestCase

\stopTestSuite

\startTestSuite[isBoolean]

\startCHeader
#define isBoolean(aLoL)             \
  (                                 \
    (                               \
      (aLoL) &&                     \
      asType(aLoL) &&               \
      (asTag(aLoL) == BooleansTag)  \
    ) ?                             \
      TRUE :                        \
      FALSE                         \
  )
\stopCHeader

\startTestSuite[isTrue and isFalse]

\startCHeader
extern Boolean isTrue(CoAlgObj* aLoL);
extern Boolean isFalse(CoAlgObj* aLoL);
\stopCHeader

\startCCode
Boolean isTrue(CoAlgObj* aLoL) {
  if (!aLoL) return FALSE;
  if (!asType(aLoL)) return FALSE;
  if (asTag(aLoL) != BooleansTag) return FALSE;
  if (asBoolean(aLoL) == FALSE) return FALSE;
  return TRUE;
}

Boolean isFalse(CoAlgObj* aLoL) {
  if (!aLoL) return TRUE;
  if (asType(aLoL) &&
     (asTag(aLoL) == BooleansTag) &&
     (asBoolean(aLoL) == FALSE)) return TRUE;
  return FALSE;
}
\stopCCode

\startTestCase[should return appropriate boolean values]

\startCTest
  CoAlgObj *aBool = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aBool);
  AssertIntTrue(asBoolean(aBool));
  AssertIntTrue(isTrue(aBool));
  AssertIntFalse(isFalse(aBool));
  aBool = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aBool);
  AssertIntFalse(asBoolean(aBool));
  AssertIntFalse(isTrue(aBool));
  AssertIntTrue(isFalse(aBool));
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{private}
\startCHeader
extern Boolean equalityBoolCoAlg(CoAlgObj* lolA, CoAlgObj* lolB,
                                 size_t debugFlag);
\stopCHeader

\startCCode
Boolean equalityBoolCoAlg(CoAlgObj* lolA, CoAlgObj* lolB,
                          size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (asType(lolA) != asType(lolB)) return FALSE;
  if (!asType(lolA)) return FALSE;
  if (asTag(lolA)  != BooleansTag) return FALSE;
  if (asBoolean(lolA) != asBoolean(lolB)) return FALSE;
  return TRUE;
}
\stopCCode

\startTestSuite[printing booleans]

\startCHeader
extern Boolean printBoolCoAlg(
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
);
\stopCHeader

\startCCode
Boolean printBoolCoAlg(
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
) {
  assert(aLoL);
  assert(asTag(aLoL) == BooleansTag);

  if (asBoolean(aLoL)) strBufPrintf(aStrBuf, "true ");
  else strBufPrintf(aStrBuf, "false ");
  return TRUE;
}
\stopCCode

\startTestCase[should print booleans]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);
  
  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  printLoLDebug(aStrBuf, aNewBoolean, FALSE);
  AssertStrEquals(getCString(aStrBuf), "true ");
  strBufClose(aStrBuf);
  
  aNewBoolean = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aNewBoolean);  
  printLoLDebug(aStrBuf, aNewBoolean, FALSE);
  AssertStrEquals(getCString(aStrBuf), "false ");
  strBufClose(aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerBooleans]

\startCHeader
extern Boolean registerBooleans(JoyLoLInterp *jInterp);
\stopCHeader

\startCCode
Boolean registerBooleans(JoyLoLInterp *jInterp) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgebra* theCoAlg    = (CoAlgebra*) calloc(1, sizeof(CoAlgebra));
  assert(theCoAlg);
  
  theCoAlg->name         = BooleansName;
  theCoAlg->objectSize   = sizeof(CoAlgObj);
  theCoAlg->registerFunc = registerBooleans;
  theCoAlg->equalityFunc = equalityBoolCoAlg;
  theCoAlg->printStr     = printBoolCoAlg;
  size_t tag = registerCoAlgebra(jInterp, theCoAlg);
  
  // do a sanity check...
  assert(tag == BooleansTag);
  assert(jInterp->coAlgs[tag].sClass);
  
  registerBooleanWords(jInterp);
  
  return TRUE;
}
\stopCCode

\startTestCase[should register the Booleans coAlg]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerBooleans
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);
  CoAlgebra *coAlg = jInterp->coAlgs[BooleansTag].sClass;
//  AssertIntTrue(registerBooleans(jInterp));
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);
  AssertPtrEquals(jInterp->coAlgs[BooleansTag].sClass, coAlg);
  AssertIntEquals(
    jInterp->coAlgs[BooleansTag].sClass->objectSize,
    sizeof(CoAlgObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{public}

\starttyping
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Booleans CoAlgebra tests -

void Test_checkBooleansSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "true");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "true");

  aNode = findSymbol(mainDic, "false");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "false");

  aNode = findSymbol(mainDic, "isBoolean");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isBoolean");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifte");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifte");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifteCont");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifteCont");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}

\stoptyping

\stopJoyLoLWord