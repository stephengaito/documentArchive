% A ConTeXt document [master document: booleans.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\component gitVersion-c

\startTestSuite[newBoolean]

\startCHeader
typedef CoAlgObj* (NewBoolean)(
  JoyLoLInterp*,
  Boolean
);

#define newBoolean(jInterp, aBool)      \
  (                                     \
    assert(getBooleansClass(jInterp)    \
      ->newBooleanFunc),                \
    (getBooleansClass(jInterp)          \
      ->newBooleanFunc(jInterp, aBool)) \
  )

#define BOOLEAN_FLAG_MASK 0x8L

#define asBoolean(aLoL) (((aLoL)->flags) & BOOLEAN_FLAG_MASK)
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern CoAlgObj* newBooleanImpl(
  JoyLoLInterp* jInterp,
  Boolean aBoolean
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
CoAlgObj* newBooleanImpl(
  JoyLoLInterp* jInterp,
  Boolean aBoolean
) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgObj* result = newObject(jInterp, BooleansTag);
  assert(result);
  
  result->type  = jInterp->coAlgs[BooleansTag].sClass;
  if (aBoolean) {
    result->flags |= BOOLEAN_FLAG_MASK;
  } else {
    result->flags &= ~BOOLEAN_FLAG_MASK;
  }
  return result;
}
\stopCCode

\startTestCase[should create a new boolean]

\startCTest
  AssertPtrNotNull(jInterp);

  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  AssertPtrNotNull(asType(aNewBoolean));
  AssertIntEquals(asTag(aNewBoolean), BooleansTag);
  AssertIntTrue(asFlags(aNewBoolean));
  AssertIntTrue(isAtom(aNewBoolean));
  AssertIntTrue(isBoolean(aNewBoolean));
  AssertIntFalse(isPair(aNewBoolean));
\stopCTest
\stopTestCase

\startTestCase[print Boolean]
\startCTest
  AssertPtrNotNull(jInterp);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);

  CoAlgObj* aLoL = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aLoL);
  printLoL(jInterp, aStrBuf, aLoL);
  AssertStrEquals(getCString(jInterp, aStrBuf), "true ");
  strBufClose(jInterp, aStrBuf);

  aLoL = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aLoL);
  printLoL(jInterp, aStrBuf, aLoL);
  AssertStrEquals(getCString(jInterp, aStrBuf), "false ");
  strBufClose(jInterp, aStrBuf);
\stopCTest
\stopTestCase

\stopTestSuite

\startTestSuite[isBoolean]

\startCHeader
#define isBoolean(aLoL)             \
  (                                 \
    (                               \
      (aLoL) &&                     \
      asType(aLoL) &&               \
      (asTag(aLoL) == BooleansTag)  \
    ) ?                             \
      TRUE :                        \
      FALSE                         \
  )
\stopCHeader

\startTestSuite[isTrue and isFalse]

\startCHeader
typedef Boolean (AssertBoolValue)(
  CoAlgObj* aLoL
);

#define isTrue(jInterp, aLoL)                     \
  (                                               \
    assert(getBooleansClass(jInterp)->isTrueFunc),\
    (getBooleansClass(jInterp)->isTrueFunc(aLoL)) \
  )

#define isFalse(jInterp, aLoL)                     \
  (                                                \
    assert(getBooleansClass(jInterp)->isFalseFunc),\
    (getBooleansClass(jInterp)->isFalseFunc(aLoL)) \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean isTrueImpl(CoAlgObj* aLoL);
extern Boolean isFalseImpl(CoAlgObj* aLoL);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean isTrueImpl(CoAlgObj* aLoL) {
  if (!aLoL) return FALSE;
  if (!asType(aLoL)) return FALSE;
  if (asTag(aLoL) != BooleansTag) return FALSE;
  if (asBoolean(aLoL) == FALSE) return FALSE;
  return TRUE;
}

Boolean isFalseImpl(CoAlgObj* aLoL) {
  if (!aLoL) return TRUE;
  if (asType(aLoL) &&
     (asTag(aLoL) == BooleansTag) &&
     (asBoolean(aLoL) == FALSE)) return TRUE;
  return FALSE;
}
\stopCCode

\startTestCase[should return appropriate boolean values]

\startCTest
  CoAlgObj *aBool = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aBool);
  AssertIntTrue(asBoolean(aBool));
  AssertIntTrue(isTrue(jInterp, aBool));
  AssertIntFalse(isFalse(jInterp, aBool));
  aBool = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aBool);
  AssertIntFalse(asBoolean(aBool));
  AssertIntFalse(isTrue(jInterp, aBool));
  AssertIntTrue(isFalse(jInterp, aBool));
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{private}
\startCHeader
extern Boolean equalityBoolCoAlg(
  JoyLoLInterp *jInterp,
  CoAlgObj     *lolA,
  CoAlgObj     *lolB
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean equalityBoolCoAlg(
  JoyLoLInterp *jInterp,
  CoAlgObj     *lolA,
  CoAlgObj     *lolB
) {
  DEBUG(jInterp, "boolCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (asType(lolA) != asType(lolB)) return FALSE;
  if (!asType(lolA)) return FALSE;
  if (asTag(lolA)  != BooleansTag) return FALSE;
  if (asBoolean(lolA) != asBoolean(lolB)) return FALSE;
  return TRUE;
}
\stopCCode

\startTestSuite[printing booleans]

\setCHeaderStream{private}
\startCHeader
extern Boolean printBoolCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean printBoolCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
) {
  assert(aLoL);
  assert(asTag(aLoL) == BooleansTag);

  if (asBoolean(aLoL)) strBufPrintf(jInterp, aStrBuf, "true ");
  else strBufPrintf(jInterp, aStrBuf, "false ");
  return TRUE;
}
\stopCCode

\startTestCase[should print booleans]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);
  
  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  printLoL(jInterp, aStrBuf, aNewBoolean);
  AssertStrEquals(getCString(jInterp, aStrBuf), "true ");
  strBufClose(jInterp, aStrBuf);
  
  aNewBoolean = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aNewBoolean);  
  printLoL(jInterp, aStrBuf, aNewBoolean);
  AssertStrEquals(getCString(jInterp, aStrBuf), "false ");
  strBufClose(jInterp, aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerBooleans]

\startCHeader
typedef struct booleans_class_struct {
  CoAlgClass       super;
  NewBoolean      *newBooleanFunc;
  AssertBoolValue *isTrueFunc;
  AssertBoolValue *isFalseFunc;
} BooleansClass;

\stopCHeader

\startCCode
static Boolean initializeBooleans(
  JoyLoLInterp *jInterp,
  CoAlgClass   *aCoAlgClass
) {
  assert(jInterp);
  assert(aCoAlgClass);
  registerBooleanWords(jInterp);
  return TRUE;
}
\stopCCode

\setCHeaderStream{private}
\startCHeader
extern Boolean registerBooleans(JoyLoLInterp *jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean registerBooleans(JoyLoLInterp *jInterp) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  BooleansClass* theCoAlg
    = joyLoLCalloc(1, BooleansClass);
  assert(theCoAlg);
  
  theCoAlg->super.name           = BooleansName;
  theCoAlg->super.objectSize     = sizeof(CoAlgObj);
  theCoAlg->super.initializeFunc = initializeBooleans;
  theCoAlg->super.equalityFunc   = equalityBoolCoAlg;
  theCoAlg->super.printFunc      = printBoolCoAlg;
  theCoAlg->newBooleanFunc       = newBooleanImpl;
  theCoAlg->isTrueFunc           = isTrueImpl;
  theCoAlg->isFalseFunc          = isFalseImpl;
  size_t tag =
    registerCoAlgClass(jInterp, (CoAlgClass*)theCoAlg);
  
  // do a sanity check...
  assert(tag == BooleansTag);
  assert(jInterp->coAlgs[tag].sClass);
   
  return TRUE;
}
\stopCCode

\startTestCase[should register the Booleans coAlg]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerBooleans
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(getBooleansClass(jInterp));
  BooleansClass *coAlg = getBooleansClass(jInterp);
  registerBooleans(jInterp);
  AssertPtrNotNull(getBooleansClass(jInterp));
  AssertPtrEquals(getBooleansClass(jInterp), coAlg);
  AssertIntEquals(
    getBooleansClass(jInterp)->super.objectSize,
    sizeof(CoAlgObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite

\starttyping
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Booleans CoAlgebra tests -

void Test_checkBooleansSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "true");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "true");

  aNode = findSymbol(mainDic, "false");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "false");

  aNode = findSymbol(mainDic, "isBoolean");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isBoolean");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifte");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifte");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifteCont");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifteCont");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}

\stoptyping

\stopJoyLoLWord