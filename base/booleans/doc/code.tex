% A ConTeXt document [master document: booleans.tex]

\section[title=Code]

\dependsOn[jInterps]
%\dependsOn[context]

\startCHeader
typedef struct boolean_struct {
  CoAlgebras super;
  size_t     theBoolean;
} Boolean;
\stopCHeader

\component gitVersion-c

\startJoyLoLWord[isBoolean]

\preDataStack[aBool][]

\starttyping
#ifndef JOYLOL_COALG_BOOLEANS_H
#define JOYLOL_COALG_BOOLEANS_H

typedef size_t Boolean;

typedef struct booleans_struct {
  CoAlgebra super;
  // other things
} Booleans;

extern Booleans* createBooleansCoAlgebra(void);
extern void initBooleansCoAlgebra(CoAlgebras* coAlgs);

extern PairAtom* newBoolean(CoAlgebras* coAlgs, size_t boolean);

extern size_t isBoolean(PairAtom* aLoL);
extern size_t isTrue(PairAtom* aLoL);
extern size_t isFalse(PairAtom* aLoL);

#endif

\stoptyping

\starttyping
\startCCode
if (!aBool) then pushDataFalse(aCtx);
if (aBool->super.isA == BOOLEANS_COALG) then
  pushDataTrue(aCtx);
pushDataFalse(aCtx);
\stopCCode
\stoptyping


\starttyping
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

static size_t equalityBoolCoAlg(CoAlgebra* klass,
                                PairAtom* lolA, PairAtom* lolB,
                                size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-equal klass:%p a:%p b:%p\n", klass, lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (lolA->coAlg != klass) return FALSE;
  if (lolB->coAlg != klass) return FALSE;
  if (lolA->boolean != lolB->boolean) return FALSE;
  return TRUE;
}

static size_t printSizeBoolCoAlg(PairAtom* aLoL, size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-printSize: %p\n", aLoL);
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == BOOLEAN_COALG);
  DEBUG(debugFlag, "boolCoAlg-printSize: bool<%zu> %p\n", aLoL->boolean, aLoL);
  return 6;
}

static size_t printStrBoolCoAlg(PairAtom* aLoL,
                                char* buffer, size_t bufferSize) {
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == BOOLEAN_COALG);

  if (aLoL->boolean) strcat(buffer, "true ");
  else strcat(buffer, "false ");
  return TRUE;
}

Booleans* createBooleansCoAlgebra(void) {
  Booleans* bools  = (Booleans*) calloc(1, sizeof(Booleans));
  initACoAlgebra((CoAlgebra*)bools);
  bools->super.isA       = BOOLEAN_COALG;
  bools->super.name      = "boolean";
  bools->super.equality  = equalityBoolCoAlg;
  bools->super.printSize = printSizeBoolCoAlg;
  bools->super.printStr  = printStrBoolCoAlg;
  return bools;
}

PairAtom* newBoolean(CoAlgebras* coAlgs, size_t aBoolean) {
  assert(coAlgs);
  PairAtom* result = newPairAtom(coAlgs);
  assert(result);
  result->coAlg   = (CoAlgebra*)coAlgs->booleans;
  result->tag     = 0;
  result->boolean = (aBoolean ? TRUE : FALSE);
  return result;
}

size_t isBoolean(PairAtom* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg && (aLoL->coAlg->isA == BOOLEAN_COALG)) return TRUE;
  return FALSE;
}

size_t isTrue(PairAtom* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg &&
     (aLoL->coAlg->isA == BOOLEAN_COALG) &&
     (aLoL->boolean == FALSE)) return FALSE;
  return TRUE;
}

size_t isFalse(PairAtom* aLoL) {
  if (!aLoL) return TRUE;
  if (aLoL->coAlg &&
     (aLoL->coAlg->isA == BOOLEAN_COALG) &&
     (aLoL->boolean == FALSE)) return TRUE;
  return FALSE;
}

static void isBooleanAP(Context* aCtx) {
  assert(aCtx);
  assert(aCtx->coAlgebras);
  popCtxDataInto(aCtx, top);
  PairAtom* result = NULL;
  if (isBoolean(top)) result = newBoolean(aCtx->coAlgebras, TRUE);
  else                result = newBoolean(aCtx->coAlgebras, FALSE);
  pushCtxData(aCtx, result);
}

static void ifteAP(Context* aCtx) {
  popCtxDataInto(aCtx, topElse);
  popCtxDataInto(aCtx, topThen);
  popCtxDataInto(aCtx, topIf);
  pushCtxProcess(aCtx, topElse); // save for later
  pushCtxProcess(aCtx, topThen); // save for later
  pushSymbolCtxProcess(aCtx, "ifteCont");
  prependListCtxProcess(aCtx, topIf); // execute the if condition
}

static void ifteContAP(Context* aCtx) {
  popCtxDataInto(aCtx, topIf);
  popCtxProcessInto(aCtx, topThen);
  popCtxProcessInto(aCtx, topElse);
  if (isTrue(topIf)) {
    prependListCtxProcess(aCtx, topThen);
  } else {
    prependListCtxProcess(aCtx, topElse);
  }
}

void initBooleansCoAlgebra(CoAlgebras* coAlgebras) {
  assert(coAlgebras);
  assert(coAlgebras->symbols);
  Dictionary* mainDic = coAlgebras->symbols->dictionary;
  assert(mainDic);

  AVLNode* true  = createSymbol(mainDic, "true");
  true->value    = newBoolean(coAlgebras, TRUE);

  AVLNode* false = createSymbol(mainDic, "false");
  false->value   = newBoolean(coAlgebras, FALSE);

  extendJoyLoL(coAlgebras, "isBoolean", isBooleanAP);
  extendJoyLoL(coAlgebras, "ifte",      ifteAP);
  extendJoyLoL(coAlgebras, "ifteCont",  ifteContAP);
}

\stoptyping

\starttyping
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Booleans CoAlgebra tests -

void Test_createBooleansCoAlgebra(CuTest* tc) {
  CoAlgebras *coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);
}

void Test_newBoolean(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  PairAtom* aNewBoolean = newBoolean(coAlgs, TRUE);
  CuAssertPtrNotNull(tc, aNewBoolean);
  CuAssertPtrNotNull(tc, aNewBoolean->coAlg);
  CuAssertIntEquals(tc, aNewBoolean->coAlg->isA, BOOLEAN_COALG);
  CuAssertTrue(tc, aNewBoolean->boolean);
  CuAssertTrue(tc, isAtom(aNewBoolean));
  CuAssertTrue(tc, isBoolean(aNewBoolean));
  CuAssertFalse(tc, isContext(aNewBoolean));
  CuAssertFalse(tc, isFunction(aNewBoolean));
  CuAssertFalse(tc, isNatural(aNewBoolean));
  CuAssertFalse(tc, isPair(aNewBoolean));
  CuAssertFalse(tc, isSymbol(aNewBoolean));
}

void Test_printBooleans(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  PairAtom* aNewBoolean = newBoolean(coAlgs, TRUE);
  CuAssertPtrNotNull(tc, aNewBoolean);
  CuAssertIntEquals(tc, printSizeDebug(aNewBoolean, FALSE), 6);
  CuAssertStrEquals(tc, printLoLDebug(aNewBoolean, FALSE), "true");

  aNewBoolean = newBoolean(coAlgs, FALSE);
  CuAssertPtrNotNull(tc, aNewBoolean);
  CuAssertIntEquals(tc, printSizeDebug(aNewBoolean, FALSE), 6);
  CuAssertStrEquals(tc, printLoLDebug(aNewBoolean, FALSE), "false");
}

void Test_checkBooleansSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "true");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "true");

  aNode = findSymbol(mainDic, "false");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "false");

  aNode = findSymbol(mainDic, "isBoolean");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isBoolean");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifte");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifte");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifteCont");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifteCont");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}

\stoptyping

\stopJoyLoLWord