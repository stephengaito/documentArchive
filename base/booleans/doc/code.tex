% A ConTeXt document [master document: booleans.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\component gitVersion-c

\startJoyLoLWord[isBoolean]

\preDataStack[aBool][]

\startTestSuite[newBoolean]

\startCHeader
extern CoAlgHandle* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean);
\stopCHeader

\startCCode
CoAlgHandle* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean) {
  assert(coAlgs);
  CoAlgHandle* result = newHandle(coAlgs);
  assert(result);
  result->type         = jInterp->coAlgs.vec[BooleanTag];
  result->tag          = 0;
  result->data.words.a = (aBoolean ? TRUE : FALSE);
  result->data.words.b = 0;
  return result;
}
\stopCCode

\startTestCase[should create a new boolean]

\startCTest
  JoyLoLInterp *jInterp = getJoyLoLInterp(lstate);
  AssertPtrNotNull(jInterp);

  CoAlgHandle* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  AssertPtrNotNull(aNewBoolean->type);
  AssertIntEquals(aNewBoolean->type->isA, BooleansTag);
  AssertIntTrue(aNewBoolean->data.words.a);
  AssertIntZero(aNewBoolean->data.words.b);
  AssertIntTrue(isAtom(aNewBoolean));
  AssertIntTrue(isBoolean(aNewBoolean));
  AssertIntFalse(isPair(aNewBoolean));
\stopCTest
\stopTestCase
\stopTestSuite

\starttyping
extern size_t isBoolean(CoAlgHandle* aLoL);
extern size_t isTrue(CoAlgHandle* aLoL);
extern size_t isFalse(CoAlgHandle* aLoL);
\stoptyping

\starttyping
\startCCode
if (!aBool) then pushDataFalse(aCtx);
if (aBool->super.isA == BOOLEANS_COALG) then
  pushDataTrue(aCtx);
pushDataFalse(aCtx);
\stopCCode
\stoptyping


\starttyping
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

static size_t equalityBoolCoAlg(CoAlgebra* klass,
                                CoAlgHandle* lolA, CoAlgHandle* lolB,
                                size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-equal klass:%p a:%p b:%p\n", klass, lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (lolA->coAlg != klass) return FALSE;
  if (lolB->coAlg != klass) return FALSE;
  if (lolA->boolean != lolB->boolean) return FALSE;
  return TRUE;
}

static size_t printSizeBoolCoAlg(CoAlgHandle* aLoL, size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-printSize: %p\n", aLoL);
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == BOOLEAN_COALG);
  DEBUG(debugFlag, "boolCoAlg-printSize: bool<%zu> %p\n", aLoL->boolean, aLoL);
  return 6;
}

static size_t printStrBoolCoAlg(CoAlgHandle* aLoL,
                                char* buffer, size_t bufferSize) {
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == BOOLEAN_COALG);

  if (aLoL->boolean) strcat(buffer, "true ");
  else strcat(buffer, "false ");
  return TRUE;
}

size_t isBoolean(CoAlgHandle* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg && (aLoL->coAlg->isA == BOOLEAN_COALG)) return TRUE;
  return FALSE;
}

size_t isTrue(CoAlgHandle* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg &&
     (aLoL->coAlg->isA == BOOLEAN_COALG) &&
     (aLoL->boolean == FALSE)) return FALSE;
  return TRUE;
}

size_t isFalse(CoAlgHandle* aLoL) {
  if (!aLoL) return TRUE;
  if (aLoL->coAlg &&
     (aLoL->coAlg->isA == BOOLEAN_COALG) &&
     (aLoL->boolean == FALSE)) return TRUE;
  return FALSE;
}
\stoptyping

\starttyping
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Booleans CoAlgebra tests -

void Test_createBooleansCoAlgebra(CuTest* tc) {
  CoAlgebras *coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);
}

void Test_printBooleans(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  CoAlgHandle* aNewBoolean = newBoolean(coAlgs, TRUE);
  CuAssertPtrNotNull(tc, aNewBoolean);
  CuAssertIntEquals(tc, printSizeDebug(aNewBoolean, FALSE), 6);
  CuAssertStrEquals(tc, printLoLDebug(aNewBoolean, FALSE), "true");

  aNewBoolean = newBoolean(coAlgs, FALSE);
  CuAssertPtrNotNull(tc, aNewBoolean);
  CuAssertIntEquals(tc, printSizeDebug(aNewBoolean, FALSE), 6);
  CuAssertStrEquals(tc, printLoLDebug(aNewBoolean, FALSE), "false");
}

void Test_checkBooleansSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "true");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "true");

  aNode = findSymbol(mainDic, "false");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "false");

  aNode = findSymbol(mainDic, "isBoolean");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isBoolean");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifte");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifte");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifteCont");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifteCont");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}

\stoptyping

\stopJoyLoLWord