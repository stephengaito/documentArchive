% A ConTeXt document [master document: booleans.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\component gitVersion-c

\startTestSuite[newBoolean]

\startCHeader
extern CoAlgObj* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean);

#define BOOLEAN_FLAG_MASK 0x8L

#define asBoolean(aLoL) (((aLoL)->flags) & BOOLEAN_FLAG_MASK)
\stopCHeader

\startCCode
CoAlgObj* newBoolean(JoyLoLInterp* jInterp, Boolean aBoolean) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgObj* result = newObject(jInterp, BooleansTag);
  assert(result);
  
  result->type  = jInterp->coAlgs[BooleansTag].sClass;
  if (aBoolean) {
    result->flags |= BOOLEAN_FLAG_MASK;
  } else {
    result->flags &= ~BOOLEAN_FLAG_MASK;
  }
  return result;
}
\stopCCode

\startTestCase[should create a new boolean]

\startCTest
  AssertPtrNotNull(jInterp);

  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  AssertPtrNotNull(aNewBoolean->type);
  AssertIntEquals(aNewBoolean->tag, BooleansTag);
  AssertIntTrue(aNewBoolean->flags);
  AssertIntTrue(isAtom(aNewBoolean));
  AssertIntTrue(isBoolean(aNewBoolean));
  AssertIntFalse(isPair(aNewBoolean));
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[isBoolean]

\startCHeader
extern size_t isBoolean(CoAlgObj* aLoL);
\stopCHeader

\startCCode
size_t isBoolean(CoAlgObj* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->type && (aLoL->tag == BooleansTag)) return TRUE;
  return FALSE;
}
\stopCCode

\startTestSuite[isTrue and isFalse]

\startCHeader
extern Boolean isTrue(CoAlgObj* aLoL);
extern Boolean isFalse(CoAlgObj* aLoL);
\stopCHeader

\startCCode
Boolean isTrue(CoAlgObj* aLoL) {
  if (!aLoL) return FALSE;
  if (!aLoL->type) return FALSE;
  if (aLoL->tag != BooleansTag) return FALSE;
  if (asBoolean(aLoL) == FALSE) return FALSE;
  return TRUE;
}

Boolean isFalse(CoAlgObj* aLoL) {
  if (!aLoL) return TRUE;
  if (aLoL->type &&
     (aLoL->tag == BooleansTag) &&
     (asBoolean(aLoL) == FALSE)) return TRUE;
  return FALSE;
}
\stopCCode

\startTestCase[should return appropriate boolean values]

\startCTest
  CoAlgObj *aBool = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aBool);
  AssertIntTrue(asBoolean(aBool));
  AssertIntTrue(isTrue(aBool));
  AssertIntFalse(isFalse(aBool));
  aBool = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aBool);
  AssertIntFalse(asBoolean(aBool));
  AssertIntFalse(isTrue(aBool));
  AssertIntTrue(isFalse(aBool));
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{private}
\startCHeader
extern Boolean equalityBoolCoAlg(CoAlgObj* lolA, CoAlgObj* lolB,
                                 size_t debugFlag);
\stopCHeader

\startCCode
Boolean equalityBoolCoAlg(CoAlgObj* lolA, CoAlgObj* lolB,
                          size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (lolA->type != lolB->type) return FALSE;
  if (lolA->tag  != BooleansTag) return FALSE;
  if (asBoolean(lolA) != asBoolean(lolB)) return FALSE;
  return TRUE;
}
\stopCCode

\startTestSuite[printing booleans]

\startCHeader
extern size_t printSizeBoolCoAlg(CoAlgObj* aLoL, size_t debugFlag);
\stopCHeader

\startCCode
size_t printSizeBoolCoAlg(CoAlgObj* aLoL, size_t debugFlag) {
  DEBUG(debugFlag, "boolCoAlg-printSize: %p\n", aLoL);
  assert(aLoL);
  assert(aLoL->type);
  assert(aLoL->tag == BooleansTag);
  DEBUG(debugFlag, "boolCoAlg-printSize: bool<%zu> %p\n", asBoolean(aLoL), aLoL);
  return 6;
}
\stopCCode

\startCHeader
extern Boolean printStrBoolCoAlg(CoAlgObj* aLoL,
                                 char* buffer, size_t bufferSize);
\stopCHeader

\startCCode
Boolean printStrBoolCoAlg(CoAlgObj* aLoL,
                          char* buffer, size_t bufferSize) {
  assert(aLoL);
  assert(aLoL->type);
  assert(aLoL->tag == BooleansTag);

  if (asBoolean(aLoL)) strcat(buffer, "true ");
  else strcat(buffer, "false ");
  return TRUE;
}
\stopCCode

\startTestCase[should print booleans]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);

  CoAlgObj* aNewBoolean = newBoolean(jInterp, TRUE);
  AssertPtrNotNull(aNewBoolean);
  AssertIntEquals(printSizeDebug(aNewBoolean, FALSE), 6);
  AssertStrEquals(printLoLDebug(aNewBoolean, FALSE), "true");

  aNewBoolean = newBoolean(jInterp, FALSE);
  AssertPtrNotNull(aNewBoolean);
  AssertIntEquals(printSizeDebug(aNewBoolean, FALSE), 6);
  AssertStrEquals(printLoLDebug(aNewBoolean, FALSE), "false");
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerBooleans]

\startCHeader
extern Boolean registerBooleans(JoyLoLInterp *jInterp);
\stopCHeader

\startCCode
Boolean registerBooleans(JoyLoLInterp *jInterp) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgebra* theCoAlg    = (CoAlgebra*) calloc(1, sizeof(CoAlgebra));
  assert(theCoAlg);
  
  theCoAlg->name         = BooleansName;
  theCoAlg->objectSize   = sizeof(CoAlgObj);
  theCoAlg->registerFunc = registerBooleans;
  theCoAlg->equalityFunc = equalityBoolCoAlg;
  theCoAlg->printSize    = printSizeBoolCoAlg;
  theCoAlg->printStr     = printStrBoolCoAlg;
  size_t tag = registerCoAlgebra(jInterp, theCoAlg);
  
  // do a sanity check...
  assert(tag == BooleansTag);
  assert(jInterp->coAlgs[tag].sClass);
  
  registerBooleanWords(jInterp);
  
  return TRUE;
}
\stopCCode

\startTestCase[should register the Booleans coAlg]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerBooleans
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);
  CoAlgebra *coAlg = jInterp->coAlgs[BooleansTag].sClass;
//  AssertIntTrue(registerBooleans(jInterp));
  AssertPtrNotNull(jInterp->coAlgs[BooleansTag].sClass);
  AssertPtrEquals(jInterp->coAlgs[BooleansTag].sClass, coAlg);
  AssertIntEquals(
    jInterp->coAlgs[BooleansTag].sClass->objectSize,
    sizeof(CoAlgObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{public}

\starttyping
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Booleans CoAlgebra tests -

void Test_checkBooleansSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->booleans);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "true");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "true");

  aNode = findSymbol(mainDic, "false");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "false");

  aNode = findSymbol(mainDic, "isBoolean");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isBoolean");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifte");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifte");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));

  aNode = findSymbol(mainDic, "ifteCont");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "ifteCont");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}

\stoptyping

\stopJoyLoLWord