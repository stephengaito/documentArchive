% A ConTeXt document [master document: strings.tex]

\section[title=Code]

\dependsOn[jInterps]
%\dependsOn[context]

\startCHeader
typedef struct strings_struct {
  CoAlgebras  super;
  const char* theString;
} Boolean;
\stopCHeader

\component gitVersion-c

\startJoyLoLWord[isString]

\preDataStack[aString][]

\stopJoyLoLWord

\starttyping
// strings.h
#ifndef JOYLOL_COALG_SYMBOLS_H
#define JOYLOL_COALG_SYMBOLS_H

typedef struct dictionary_struct Dictionary;

typedef const char Symbol;

typedef struct symbols_struct {
  CoAlgebra super;
  Dictionary* dictionary;
  // other things
} Symbols;

extern Symbols* createSymbolsCoAlgebra(void);
extern void initSymbolsCoAlgebra(CoAlgebras* coAlgs);

extern PairAtom* newSymbol(CoAlgebras* coAlgs, const char* aSymbol);

extern size_t isSymbol(PairAtom* aLoL);
extern size_t symbolIs(PairAtom* aLoL, Symbol* aSymbol);

#endif
\stoptyping

\starttyping
// strings.c
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/printer.h"
#include "joyLoL/dictionary.h"

static size_t equalitySymbolCoAlg(CoAlgebra* klass,
                                  PairAtom* lolA, PairAtom* lolB,
                                  size_t debugFlag) {
  DEBUG(debugFlag, "symbolCoAlg-equal klass:%p a:%p b:%p\n", klass, lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (lolA->coAlg != klass) return FALSE;
  if (lolB->coAlg != klass) return FALSE;
  if (strcmp(lolA->symbol, lolB->symbol) != 0) return FALSE;
  return TRUE;
}

static size_t printSizeSymbolCoAlg(PairAtom* aLoL, size_t debugFlag) {
  DEBUG(debugFlag, "symbolCoAlg-printSize: %p\n", aLoL);
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == SYMBOL_COALG);
  DEBUG(debugFlag, "symbolCoAlg-printSize: [%s] %p\n", aLoL->symbol, aLoL);
  return strlen(aLoL->symbol) + 1;
}

static size_t printStrSymbolCoAlg(PairAtom* aLoL,
                                  char* buffer, size_t bufferSize) {
  assert(aLoL);
  assert(aLoL->coAlg);
  assert(aLoL->coAlg->isA == SYMBOL_COALG);

  strcat(buffer, aLoL->symbol);
  strcat(buffer, " ");
  return TRUE;
}

Symbols* createSymbolsCoAlgebra(void) {
  Symbols* symbols = (Symbols*) calloc(1, sizeof(Symbols));
  initACoAlgebra((CoAlgebra*)symbols);

  symbols->super.isA       = SYMBOL_COALG;
  symbols->super.name      = "symbol";
  symbols->super.equality  = equalitySymbolCoAlg;
  symbols->super.printSize = printSizeSymbolCoAlg;
  symbols->super.printStr  = printStrSymbolCoAlg;

  symbols->dictionary = createDictionary();     // lazy init

  return symbols;
}

PairAtom* newSymbol(CoAlgebras* coAlgs, const char* aSymbol) {
  assert(aSymbol);
  assert(coAlgs);
  PairAtom* result = newPairAtom(coAlgs);
  assert(result);
  result->coAlg  = (CoAlgebra*)coAlgs->symbols;
  result->tag    = 0;
  result->symbol = strdup(aSymbol);
  return result;
}

size_t isSymbol(PairAtom* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg && (aLoL->coAlg->isA == SYMBOL_COALG)) return TRUE;
  return FALSE;
}

size_t symbolIs(PairAtom* aLoL, Symbol* aSymbol) {
  if (!aLoL) return FALSE;
  if (!isSymbol(aLoL)) return FALSE;
  if (strcmp(aLoL->symbol, aSymbol) == 0) return TRUE;
  return FALSE;
}

static void isSymbolAP(Context* aCtx) {
  assert(aCtx);
  assert(aCtx->coAlgebras);
  popCtxDataInto(aCtx, top);
  PairAtom* result = NULL;
  if (isSymbol(top)) result = newBoolean(aCtx->coAlgebras, TRUE);
  else               result = newBoolean(aCtx->coAlgebras, FALSE);
  pushCtxData(aCtx, result);
}

static void equalSymbolAP(Context* aCtx) {
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  size_t result = FALSE;
  if (isSymbol(top1) && isSymbol(top2)) {
    if (strcmp(top1->symbol, top2->symbol) == 0) result = TRUE;
  }
  DEBUG(FALSE, "equalSymbol: %zu\n", result);
  pushCtxData(aCtx, newBoolean(aCtx->coAlgebras, result));
}

void initSymbolsCoAlgebra(CoAlgebras* coAlgs) {
  extendJoyLoL(coAlgs, "isSymbol", isSymbolAP);
  extendJoyLoL(coAlgs, "=Sym",     equalSymbolAP);
}
\stoptyping

\starttyping
// specs
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/dictionary.h"
#include "joyLoL/printer.h"

// suiteName: - Symbols CoAlgebra tests -

void Test_createSymbolsCoAlgebra(CuTest* tc) {
  CoAlgebras *coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->symbols);
}

void Test_newSymbol(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->symbols);

  const char* testStr = "test string";
  PairAtom* aNewSymbol = newSymbol(coAlgs, testStr);
  CuAssertPtrNotNull(tc, aNewSymbol);
  CuAssertPtrNotNull(tc, aNewSymbol->coAlg);
  CuAssertIntEquals(tc, aNewSymbol->coAlg->isA, SYMBOL_COALG);
  CuAssertPtrNotNull(tc, aNewSymbol->symbol);
  CuAssertPtrNotEquals(tc, (void*)aNewSymbol->symbol, (void*)testStr);
  CuAssertIntEquals(tc, strcmp(aNewSymbol->symbol, testStr), 0);
  CuAssertTrue(tc, isSymbol(aNewSymbol));
  CuAssertTrue(tc, isAtom(aNewSymbol));
  CuAssertFalse(tc, isBoolean(aNewSymbol));
  CuAssertFalse(tc, isContext(aNewSymbol));
  CuAssertFalse(tc, isFunction(aNewSymbol));
  CuAssertFalse(tc, isNatural(aNewSymbol));
  CuAssertFalse(tc, isPair(aNewSymbol));
}

void Test_printSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);
  CuAssertPtrNotNull(tc, coAlgs->symbols);

  const char* testStr = "test string";
  PairAtom* aNewSymbol = newSymbol(coAlgs, testStr);
  CuAssertPtrNotNull(tc, aNewSymbol);
  CuAssertIntEquals(tc, printSizeDebug(aNewSymbol, FALSE), strlen(testStr)+1);
  CuAssertStrEquals(tc, printLoLDebug(aNewSymbol, FALSE), testStr);
}

void Test_checkSymbolsSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "isSymbol");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isSymbol");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}
\stoptyping