% A ConTeXt document [master document: dictionaries.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\component gitVersion-c

\startTestSuite[newDictionary]

\startCHeader
typedef JObj* (NewDictionary)(
  JoyLoLInterp*
);

#define newDictionary(jInterp)            \
  (                                       \
    assert(getDictionariesClass(jInterp)  \
      ->newDictionaryFunc),               \
    (getDictionariesClass(jInterp)        \
      ->newDictionaryFunc(jInterp))       \
  )

//#define asDictionary(aLoL) (((aLoL)->flags) & BOOLEAN_FLAG_MASK)
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern JObj* newDictionaryImpl(
  JoyLoLInterp *jInterp
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
JObj* newDictionaryImpl(
  JoyLoLInterp *jInterp
) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  JObj* result = newObject(jInterp, DictionariesTag);
  assert(result);
  
  result->type  = jInterp->coAlgs[DictionariesTag].sClass;
 
  return result;
}
\stopCCode

\startTestCase[should create a new Dictionary]

\startCTest
  AssertPtrNotNull(jInterp);

  JObj* aNewDictionary = newDictionary(jInterp);
  AssertPtrNotNull(aNewDictionary);
  AssertPtrNotNull(asType(aNewDictionary));
  AssertIntEquals(asTag(aNewDictionary), DictionariesTag);
  AssertIntTrue(isAtom(aNewDictionary));
  AssertIntTrue(isDictionary(aNewDictionary));
  AssertIntFalse(isPair(aNewDictionary));
\stopCTest
\stopTestCase

\startTestSuite[findSymbol]

\startCHeader
typedef DictNodeObj *(FindSymbol)(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);

#define findSymbol(jInterp, aSymbol)      \
  (                                       \
    assert(getDictionariesClass(jInterp)  \
      ->findSymbolFunc),                  \
    (getDictionariesClass(jInterp)        \
      ->findSymbolFunc(jInterp, aSymbol)) \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern DictNodeObj* findSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
DictNodeObj* findSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
) {
  if (!aSymbol) return NULL;
  assert(jInterp);
  return findSymbolRecurse(jInterp, jInterp->dict.root, aSymbol);
}
\stopCCode
\stopTestSuite

\startTestSuite[insertSymbol]

\startCHeader
typedef DictNodeObj *(InsertSymbol)(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);

#define insertSymbol(jInterp, aSymbol)      \
  (                                         \
    assert(getDictionariesClass(jInterp)    \
      ->insertSymbolFunc),                  \
    (getDictionariesClass(jInterp)          \
      ->insertSymbolFunc(jInterp, aSymbol)) \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern DictNodeObj* insertSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
DictNodeObj* insertSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
) {
  assert(aSymbol);
  assert(jInterp);

  // lazy initialization
  if (!jInterp->dict.root) {
    DictNodeObj* firstNode    = newDictNode(jInterp, aSymbol);
    jInterp->dict.root        = firstNode;
    jInterp->dict.firstSymbol = firstNode;
    return firstNode;
  }

  return insertSymbolRecurse(jInterp, jInterp->dict.root, aSymbol);
}
\stopCCode
\stopTestSuite

\startTestSuite[findLUBSymbol]
\startCHeader
typedef DictNodeObj *(FindLUBSymbol)(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);

#define findLUBSymbol(jInterp, aSymbol)       \
  (                                           \
    assert(getDictionariesClass(jInterp)      \
      ->findLUBSymbolFunc),                   \
    (getDictionariesClass(jInterp)            \
      ->findLUBSymbolFunc(jInterp, aSymbol))  \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern DictNodeObj* findLUBSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
DictNodeObj* findLUBSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
) {
  assert(jInterp);
  if (!aSymbol) return jInterp->dict.firstSymbol;
  return findLUBSymbolRecurse(jInterp, jInterp->dict.root, aSymbol);
}
\stopCCode
\stopTestSuite

\startTestSuite[createSymbol]

\startCHeader
typedef DictNodeObj *(CreateSymbol)(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);

#define createSymbol(jInterp, aSymbol)      \
  (                                         \
    assert(getDictionariesClass(jInterp)    \
      ->createSymbolFunc),                  \
    (getDictionariesClass(jInterp)          \
      ->createSymbolFunc(jInterp, aSymbol)) \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern DictNodeObj* createSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
DictNodeObj* createSymbolImpl(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
) {
  assert(jInterp);
  if (!aSymbol) return NULL;
  DictNodeObj* aSym = findSymbol(jInterp, aSymbol);
  if (!aSym) {
    jInterp->dict.root = insertSymbol(jInterp, aSymbol);
    aSym = findSymbol(jInterp, aSymbol);
  }
  return aSym;
}
\stopCCode
\stopTestSuite

\startTestSuite[getSymbol]

\startCHeader
typedef JObj *(GetSymbol)(
  JoyLoLInterp *jInterp,
  Symbol       *aSymbol
);

#define getSymbol(jInterp, aSymbol)       \
  (                                       \
    assert(getDictionariesClass(jInterp)  \
      ->getSymbolFunc),                   \
    (getDictionariesClass(jInterp)        \
      ->getSymbolFunc(jInterp, aSymbol))  \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern JObj* getSymbolImpl(
  JoyLoLInterp* jInterp,
  Symbol* aSymbol
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
JObj* getSymbolImpl(
  JoyLoLInterp* jInterp,
  Symbol* aSymbol
) {
  DictNodeObj* aSym = createSymbol(jInterp, aSymbol);
  return newSymbol(jInterp, aSym->symbol);
}
\stopCCode
\stopTestSuite

\startTestSuite[listDefinitions]

\startCHeader
typedef void (ListDefinitions)(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf
);

#define listDefinitions(jInterp, aStrBuf)       \
  (                                             \
    assert(getDictionariesClass(jInterp)        \
      ->listDefinitionsFunc),                   \
    (getDictionariesClass(jInterp)              \
      ->listDefinitionsFunc(jInterp, aStrBuf))  \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern void listDefinitionsImpl(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
void listDefinitionsImpl(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf
) {
  DictNodeObj* curNode = jInterp->dict.firstSymbol;
  while(curNode) {
    if (curNode->value) {
      strBufPrintf(jInterp, aStrBuf,"%s == ", curNode->symbol);
      printLoL(jInterp, aStrBuf, curNode->value);
      strBufPrintf(jInterp, aStrBuf,"\n");
    }
    curNode = curNode->next;
  }
}
\stopCCode
\stopTestSuite


\startTestCase[print Dictionary]
\startCTest
  AssertPtrNotNull(jInterp);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);

  JObj* aLoL = newDictionary(jInterp);
  AssertPtrNotNull(aLoL);
  printLoL(jInterp, aStrBuf, aLoL);
  AssertStrEquals(getCString(jInterp, aStrBuf), "dictionary ");
  strBufClose(jInterp, aStrBuf);
\stopCTest
\stopTestCase

\stopTestSuite

\startTestSuite[isDictionary]

\startCHeader
#define isDictionary(aLoL)              \
  (                                     \
    (                                   \
      (aLoL) &&                         \
      asType(aLoL) &&                   \
      (asTag(aLoL) == DictionariesTag)  \
    ) ?                                 \
      TRUE :                            \
      FALSE                             \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean equalityDictionaryCoAlg(
  JoyLoLInterp *jInterp,
  JObj     *lolA,
  JObj     *lolB
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean equalityDictionaryCoAlg(
  JoyLoLInterp *jInterp,
  JObj     *lolA,
  JObj     *lolB
) {
  DEBUG(jInterp, "dictionaryCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (asType(lolA) != asType(lolB)) return FALSE;
  if (!asType(lolA)) return FALSE;
  if (asTag(lolA)  != DictionariesTag) return FALSE;
  if (lolA != lolB) return FALSE;
  return TRUE;
}
\stopCCode

\startTestSuite[printing dictionaries]

\setCHeaderStream{private}
\startCHeader
extern Boolean printDictionaryCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  JObj        *aLoL
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean printDictionaryCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  JObj        *aLoL
) {
  assert(aLoL);
  assert(asTag(aLoL) == DictionariesTag);

  strBufPrintf(jInterp, aStrBuf, "dictionary ");
  return TRUE;
}
\stopCCode

\startTestCase[should print dictionaries]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[DictionariesTag].sClass);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);
  
  JObj* aNewDictionary = newDictionary(jInterp);
  AssertPtrNotNull(aNewDictionary);
  printLoL(jInterp, aStrBuf, aNewDictionary);
  AssertStrEquals(getCString(jInterp, aStrBuf), "dictionary ");
  strBufClose(jInterp, aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerDictionaries]

\startCHeader
typedef struct dictionaries_class_struct {
  JClass           super;
  NewDictionary   *newDictionaryFunc;
  CreateSymbol    *createSymbolFunc;
  GetSymbol       *getSymbolFunc;
  FindSymbol      *findSymbolFunc;
  InsertSymbol    *insertSymbolFunc;
  FindLUBSymbol   *findLUBSymbolFunc;
  ListDefinitions *listDefinitionsFunc;  
} DictionariesClass;

\stopCHeader

\startCCode
static Boolean initializeDictionaries(
  JoyLoLInterp *jInterp,
  JClass       *aJClass
) {
  assert(jInterp);
  assert(aJClass);
  registerDictionaryWords(jInterp);
  return TRUE;
}
\stopCCode

\setCHeaderStream{private}
\startCHeader
extern Boolean registerDictionaries(JoyLoLInterp *jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean registerDictionaries(JoyLoLInterp *jInterp) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  DictionariesClass* theCoAlg
    = joyLoLCalloc(1, DictionariesClass);
  assert(theCoAlg);
  
  theCoAlg->super.name           = DictionariesName;
  theCoAlg->super.objectSize     = sizeof(JObj);
  theCoAlg->super.initializeFunc = initializeDictionaries;
  theCoAlg->super.equalityFunc   = equalityDictionaryCoAlg;
  theCoAlg->super.printFunc      = printDictionaryCoAlg;
  theCoAlg->newDictionaryFunc = newDictionaryImpl;
  theCoAlg->createSymbolFunc      = createSymbolImpl;
  theCoAlg->getSymbolFunc         = getSymbolImpl;
  theCoAlg->findSymbolFunc        = findSymbolImpl;
  theCoAlg->insertSymbolFunc      = insertSymbolImpl;
  theCoAlg->findLUBSymbolFunc     = findLUBSymbolImpl;
  theCoAlg->listDefinitionsFunc   = listDefinitionsImpl;  
  size_t tag =
    registerJClass(jInterp, (JClass*)theCoAlg);
  
  // do a sanity check...
  assert(tag == DictionariesTag);
  assert(jInterp->coAlgs[tag].sClass);
   
  return TRUE;
}
\stopCCode

\startTestCase[should register the Dictionaries coAlg]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerDictionaries
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(getDictionariesClass(jInterp));
  DictionariesClass *coAlg = getDictionariesClass(jInterp);
  registerDictionaries(jInterp);
  AssertPtrNotNull(getDictionariesClass(jInterp));
  AssertPtrEquals(getDictionariesClass(jInterp), coAlg);
  AssertIntEquals(
    getDictionariesClass(jInterp)->super.objectSize,
    sizeof(JObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite
