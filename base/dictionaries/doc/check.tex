% A ConTeXt document [master document: dictionaries.tex]

\section[title=Check]
\setCHeaderStream{private}

\startTestSuite[reCalculateAVLNodeHeight]

\startCHeader
extern void reCalculateAVLNodeHeightBalance(DictObj* anAVLNode);
\stopCHeader

\startCCode
void reCalculateAVLNodeHeightBalance(DictObj* anAVLNode) {
  if (!anAVLNode) return;

  if (!anAVLNode->left && !anAVLNode->right) {
    anAVLNode->height  = 1;
    anAVLNode->balance = 0;
  } else if (!anAVLNode->left) {
    anAVLNode->height  =  1 + anAVLNode->right->height;
    anAVLNode->balance = -1 - anAVLNode->right->height;
  } else if (!anAVLNode->right) {
    anAVLNode->height  = 1 + anAVLNode->left->height;
    anAVLNode->balance = 1 + anAVLNode->left->height;
  } else if (anAVLNode->left->height < anAVLNode->right->height) {
    anAVLNode->height  = 1 + anAVLNode->right->height;
    anAVLNode->balance = anAVLNode->left->height - anAVLNode->right->height;
  } else {
    anAVLNode->height  = 1 + anAVLNode->left->height;
    anAVLNode->balance = anAVLNode->left->height - anAVLNode->right->height;
  }
}
\stopCCode

\startTestCase[should computer correct AVLNode heights]
\startCTest
  AssertPtrNotNull(jInterp);

  StringBufferObj* aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);
  
  DictObj* aNode = newDict(jInterp, "20");
  AssertPtrNotNull(aNode);
  printDicInto(jInterp, aStrBuf, aNode);
  AssertStrEquals(getCString(jInterp, aStrBuf),
  "[20] l:(  ) r:(  ) ");
  strBufClose(jInterp, aStrBuf);

  AssertIntEquals(aNode->height, 1);
  reCalculateAVLNodeHeightBalance(aNode);
  AssertIntEquals(aNode->height, 1);
  AssertIntEquals(aNode->balance, 0);

  aNode->left = newDict(jInterp, "15");
  printDicInto(jInterp, aStrBuf, aNode);
  AssertStrEquals(getCString(jInterp, aStrBuf),
  "[20] l:( [15] l:(  ) r:(  )  ) r:(  ) ");
  strBufClose(jInterp, aStrBuf);
  reCalculateAVLNodeHeightBalance(aNode);
  AssertIntEquals(aNode->height, 2);
  AssertIntEquals(aNode->balance, 2);

  aNode->right = newDict(jInterp, "25");
  printDicInto(jInterp, aStrBuf, aNode);
  AssertStrEquals(getCString(jInterp, aStrBuf),
  "[20] l:( [15] l:(  ) r:(  )  ) r:( [25] l:(  ) r:(  )  ) ");
  strBufClose(jInterp, aStrBuf);
  reCalculateAVLNodeHeightBalance(aNode);
  AssertIntEquals(aNode->height, 2);
  AssertIntEquals(aNode->balance, 0);
\stopCTest
\stopTestCase
\stopTestSuite

\startCHeader
extern size_t deepCalculateAVLNodeHeight(DictObj* anAVLNode);
\stopCHeader

\startCCode
size_t deepCalculateAVLNodeHeight(DictObj* anAVLNode) {
  if (!anAVLNode) return 0;

  size_t leftHeight = 1 + deepCalculateAVLNodeHeight(anAVLNode->left);
  size_t rightHeight = 1 + deepCalculateAVLNodeHeight(anAVLNode->right);

  if (leftHeight > rightHeight) return leftHeight;
  return rightHeight;
}
\stopCCode

\startCHeader
extern Boolean checkAVLNode(
  JoyLoLInterp *jInterp,
  DictObj      *anAVLNode,
  Boolean       debugFlag
);
\stopCHeader

\startCCode
Boolean checkAVLNode(
  JoyLoLInterp *jInterp,
  DictObj      *anAVLNode, 
  Boolean       debugFlag
) {
  if (!anAVLNode) return TRUE;
  if (debugFlag) {
    StringBufferObj *aStrBuf = 
      newStringBuffer(jInterp);
    printDicInto(jInterp, aStrBuf, anAVLNode);
    DEBUG(debugFlag, "checkAVLNode %p %ld:%zu=%zu %s\n",
          anAVLNode, anAVLNode->balance, anAVLNode->height,
          deepCalculateAVLNodeHeight(anAVLNode),
          getCString(jInterp, aStrBuf));
    strBufClose(jInterp, aStrBuf);
  }

  if (anAVLNode->left) {
      DEBUG(debugFlag, "car>-checkAVLNode %p\n", anAVLNode);
      checkAVLNode(jInterp, anAVLNode->left, debugFlag);
      assert(0 < strcmp(anAVLNode->symbol,
                      anAVLNode->left->symbol));
    DEBUG(debugFlag, "car<-checkAVLNode %p\n", anAVLNode);
  }

  if (anAVLNode->right) {
    DEBUG(debugFlag, "cdr>-checkAVLNode %p\n", anAVLNode);
    checkAVLNode(jInterp, anAVLNode->right, debugFlag);
    assert(strcmp(anAVLNode->symbol,
                  anAVLNode->right->symbol) < 0);
    DEBUG(debugFlag, "cdr<-checkAVLNode %p\n", anAVLNode);
  }

  assert(anAVLNode->height == deepCalculateAVLNodeHeight(anAVLNode));

  return TRUE;
}
\stopCCode

\setCHeaderStream{public}
