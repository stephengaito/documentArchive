% A ConTeXt document [master document: pairs.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\startCHeader
typedef struct pairs_object_struct {
  CoAlgObj  super;
  CoAlgObj* car;
  CoAlgObj* cdr;
} PairsObj;
\stopCHeader

\startTestSuite[newPair]

\startCHeader
extern CoAlgObj* newPair(
  JoyLoLInterp* jInterp,
  CoAlgObj* car,
  CoAlgObj* cdr
);

#define asCar(aLoL) (((PairsObj*)(aLoL))->car)
#define asCdr(aLoL) (((PairsObj*)(aLoL))->cdr)
\stopCHeader

\startCCode
CoAlgObj* newPair(
  JoyLoLInterp* jInterp,
  CoAlgObj* car,
  CoAlgObj* cdr
) {
  assert(jInterp);
  CoAlgObj* result = newObject(jInterp, PairsTag);
  assert(result);
  result->type  = jInterp->coAlgs[PairsTag].sClass;
  result->tag   = PairsTag;
  result->flags = 0;
  asCar(result) = car;
  asCdr(result) = cdr;
  return result;
}
\stopCCode

\startTestCase[should create a new pair]

\startCTest
  JoyLoLInterp *jInterp = getJoyLoLInterp(lstate);
  AssertPtrNotNull(jInterp);
  
  CoAlgObj *lolA = newPair(jInterp, NULL, NULL);
  CoAlgObj *lolB = newPair(jInterp, NULL, NULL);
  CoAlgObj *lol  = newPair(jInterp, lolA, lolB);
  AssertPtrEquals(lol->type, jInterp->coAlgs[PairsTag].sClass);
  AssertIntEquals(lol->tag, PairsTag);
  AssertIntZero(lol->flags);
  AssertPtrEquals(asCar(lol), lolA);
  AssertPtrEquals(asCdr(lol), lolB);  
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[car and cdr]

\startCHeader
extern CoAlgObj* car(CoAlgObj* aLoL);
extern CoAlgObj* cdr(CoAlgObj* aLoL);
\stopCHeader

\startCCode
CoAlgObj* car(CoAlgObj* aLoL) {
  if (!aLoL) return NULL;
  if (aLoL->type && (aLoL->tag != PairsTag)) return aLoL;
  return asCar(aLoL);
}

CoAlgObj* cdr(CoAlgObj* aLoL) {
  if (!aLoL) return NULL;
  if (aLoL->type && (aLoL->tag != PairsTag)) return NULL;
  return asCdr(aLoL);
}
\stopCCode

\startTestCase[should return the car and cdr]

\startCTest
  CoAlgObj *pairA = newPair(jInterp, NULL, NULL);
  CoAlgObj *pairB = newPair(jInterp, NULL, NULL);
  CoAlgObj *aPair = newPair(jInterp, pairA, pairB);
  AssertPtrEquals(car(aPair), pairA);
  AssertPtrEquals(cdr(aPair), pairB);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[copyLoL]

\startCHeader
extern CoAlgObj* copyLoL(
  JoyLoLInterp* jInterp,
  CoAlgObj* aLoL
);
\stopCHeader

\startCCode
CoAlgObj* copyLoL(
  JoyLoLInterp* jInterp,
  CoAlgObj* aLoL
) {
  assert(jInterp);
  if (!aLoL) return NULL;
  if (isAtom(aLoL)) return aLoL;

  return newPair(jInterp,
                 copyLoL(jInterp, asCar(aLoL)),
                 copyLoL(jInterp, asCdr(aLoL))
                 );
}
\stopCCode

\startTestCase[should make a correct copy]

\startCTest
  CoAlgObj *bool   = newBoolean(jInterp, TRUE);
  CoAlgObj *pairA  = newPair(jInterp, bool, NULL);
  CoAlgObj *pairB  = newPair(jInterp, pairA, bool);
  CoAlgObj *aPair0 = newPair(jInterp, pairA, pairB);
  CoAlgObj *aPair1 = copyLoL(jInterp, aPair0);
  AssertPtrNotNull(bool);
  AssertPtrNotNull(pairA);
  AssertPtrNotNull(pairB);
  AssertPtrNotNull(aPair0);
  AssertPtrNotNull(aPair1);
  AssertPtrNotNull(aPair1->type);
  AssertPtrEquals(aPair1->type, jInterp->coAlgs[PairsTag].sClass);

  AssertPtrNotNull(asCar(aPair1));
  AssertPtrNotEquals(asCar(aPair1), pairA);

  AssertPtrNotNull(asCar(asCar(aPair1)));
  AssertPtrEquals(asCar(asCar(aPair1)), bool);
  AssertIntTrue(isBoolean(asCar(asCar(aPair1))));
  AssertIntTrue(isTrue(asCar(asCar(aPair1))));

  AssertPtrNull(asCdr(asCar(aPair1)));

  AssertPtrNotNull(asCdr(aPair1));
  AssertPtrNotEquals(asCdr(aPair1), pairB);

  AssertPtrNotNull(asCar(asCdr(aPair1)));
  AssertIntTrue(isPair(asCar(asCdr(aPair1))));

  AssertPtrNotNull(asCdr(asCdr(aPair1)));
  AssertPtrEquals(asCdr(asCdr(aPair1)), bool);
  AssertIntTrue(isBoolean(asCdr(asCdr(aPair1))));
  AssertIntTrue(isTrue(asCdr(asCdr(aPair1))));
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[equalLoL]

\startCHeader
extern Boolean equalLoLDebug(
  CoAlgObj* lolA,
  CoAlgObj* lolB,
  Boolean debugFlag
);

#define equalLoL(lolA, lolB) equalLoLDebug(lolA, lolB, FALSE)
\stopCHeader

\startCCode
Boolean equalLoLDebug(
  CoAlgObj* lolA,
  CoAlgObj* lolB,
  Boolean debugFlag
) {
  DEBUG(debugFlag, "equalLoL %p %p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA || !lolB) return FALSE;
  if (lolA->type != lolB->type) return FALSE;
  if (lolA->type && 
     (lolA->tag != PairsTag)) {
    return (lolA->type->equalityFunc)(lolA, lolB, debugFlag);
  }
  
  if (!equalLoLDebug(asCar(lolA), asCar(lolB), debugFlag)) {
    return FALSE;
  }
  return equalLoLDebug(asCdr(lolA), asCdr(lolB), debugFlag);
}
\stopCCode

\startTestCase[should return true if pairs are equal]
\startCTest
  CoAlgObj *pairA = newPair(jInterp, NULL, NULL);
  CoAlgObj *pairB = newPair(jInterp, NULL, NULL);
  AssertIntTrue(equalLoL(NULL, NULL));
  AssertIntTrue(equalLoL(pairA, pairB));
  // need to test with NON-Pairs
\stopCTest
\stopTestCase

\startTestCase[should return false if pairs are not equal]
\startCTest
  CoAlgObj *pairA = newPair(jInterp, NULL,  NULL);
  CoAlgObj *pairB = newPair(jInterp, pairA, NULL);
  AssertIntFalse(equalLoL(pairA, pairB));
  // need to test with NON-Pairs
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[printing pairs]

\setCHeaderStream{private}
\startCHeader
extern size_t printSizePairsCoAlg(CoAlgObj* aLoL, Boolean debugFlag);
\stopCHeader

\startCCode
#define lolPrintSize(lolSize, aLoL, defSize, typeStr, selector, debugFlag)\
  if (aLoL) {								                                              \
    DEBUG(debugFlag, "%sCoAlg-printSize: -> %s(%p) %zu\n",		            \
          typeStr, selector, aLoL, lolSize);				                          \
    assert((aLoL)->type);						                                      \
    lolSize += ((aLoL)->type->printSize)((aLoL), debugFlag);		          \
    DEBUG(debugFlag, "%sCoAlg-printSize: <- %s(%p) %zu\n",		            \
          typeStr, selector, aLoL, lolSize);				                      \
  } else {								                                                \
    lolSize += defSize;							                                      \
  }

size_t printSizePairsCoAlg(CoAlgObj* aLoL, Boolean debugFlag) {
  DEBUG(debugFlag, "pairsCoAlg-printSize: > %p\n", aLoL);
  assert(aLoL);
  assert(aLoL->type);
  assert(aLoL->tag == PairsTag);

//  if ((AS_TAG(aLoL->coAlg) & PRINT_MARKER)) return 0;
//  aLoL->coAlg = (CoAlgebra*)(AS_TAG(aLoL->coAlg) | PRINT_MARKER);

  DEBUG(debugFlag, "pairsCoAlg-printSize: %p {%p:%zu}(%p, %p)\n", aLoL,
        aLoL->type, (size_t)(aLoL->tag), asCar(aLoL), asCdr(aLoL));

  size_t lolSize = 4;
  lolPrintSize(lolSize, asCar(aLoL), 4, "pairs", "car", debugFlag);
  lolPrintSize(lolSize, asCdr(aLoL), 4, "pairs", "cdr", debugFlag);

  DEBUG(debugFlag, "pairsCoAlg-printSize: < %zu %p\n", lolSize, aLoL);
  return lolSize;
}
\stopCCode

\startCHeader
extern Boolean printStrPairsCoAlg(CoAlgObj* aLoL,
                                  char* buffer, size_t bufferSize);
\stopCHeader

\startCCode
#define lolPrintStr(printedOk, aLoL, opener, closer, buffer, bufferSize)\
  if (aLoL) {								                                            \
    size_t isList = (aLoL)->tag == PairsTag;        			              \
    if (isList) strcat(buffer, opener);					                        \
    assert((aLoL)->type);						                                    \
    printedOk = printedOk && 						                                \
      ((aLoL)->type->printStr)((aLoL), buffer, bufferSize);		          \
    if (isList) strcat(buffer, closer);					                        \
  } else {								                                              \
    strcat(buffer, opener);						                                  \
    strcat(buffer, closer);						                                  \
  }
  
Boolean printStrPairsCoAlg(CoAlgObj* aLoL,
                           char* buffer, size_t bufferSize) {
  assert(aLoL);
  assert(aLoL->type);
  assert(aLoL->tag == PairsTag);

//  if (!(AS_TAG(aLoL->coAlg) & PRINT_MARKER)) return TRUE;
//  aLoL->coAlg = (CoAlgebra*)(AS_TAG(aLoL->coAlg) & (~ PRINT_MARKER));

  size_t printedOk = TRUE;
  lolPrintStr(printedOk, asCar(aLoL), "( ", ") ", buffer, bufferSize);
  lolPrintStr(printedOk, asCdr(aLoL), "",   "",   buffer, bufferSize);
  return printedOk;
}
\stopCCode

\startTestCase[should print pairs]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[PairsTag].sClass);

  CoAlgObj* aNewPair = newPair(jInterp,
                               newPair(jInterp, NULL, NULL),
                               newPair(jInterp, NULL, NULL));
  AssertPtrNotNull(aNewPair);
  AssertIntEquals(printSizeDebug(aNewPair, FALSE), 28);
  AssertStrEquals(printLoLDebug(aNewPair, FALSE), "( ( ) ) ( )");
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerPairs]

\startCHeader
extern Boolean registerPairs(JoyLoLInterp *jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean registerPairs(JoyLoLInterp *jInterp) {
  assert(jInterp);
  
  CoAlgebra* theCoAlg    = (CoAlgebra*) calloc(1, sizeof(CoAlgebra));
  theCoAlg->name         = strdup("Pairs");
  theCoAlg->objectSize   = sizeof(PairsObj);
  theCoAlg->registerFunc = registerPairs;
  theCoAlg->equalityFunc = equalLoLDebug;
  theCoAlg->printSize    = printSizePairsCoAlg;
  theCoAlg->printStr     = printStrPairsCoAlg;
  size_t tag = registerCoAlgebra(jInterp, theCoAlg);
  
  // sanity check...
  assert(tag == PairsTag);
  assert(jInterp->coAlgs[tag].sClass);
    
  registerPairsWords(jInterp);
  
  return TRUE;
}
\stopCCode

\startTestCase[should register the Pairs coAlg]

\startCTest
  // CTestSetup has already created a jInterp
  // and run registerPairs
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[PairsTag].sClass);
  CoAlgebra *coAlg = jInterp->coAlgs[PairsTag].sClass;
  AssertIntTrue(registerPairs(jInterp));
  AssertPtrNotNull(jInterp->coAlgs[PairsTag].sClass);
  AssertPtrEquals(jInterp->coAlgs[PairsTag].sClass, coAlg);
  AssertIntEquals(
    jInterp->coAlgs[PairsTag].sClass->objectSize,
    sizeof(PairsObj)
  );
\stopCTest
\stopTestCase
\stopTestSuite

\setCHeaderStream{public}

\starttyping
// specs

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "CuTest.h"

#include "joyLoL/macros.h"
#include "joyLoL/coAlg/coAlgs.h"
#include "joyLoL/lists.h"
#include "joyLoL/lists_private.h"
#include "joyLoL/printer.h"

// suiteName: - Pairs CoAlgebra tests -


\stoptyping
