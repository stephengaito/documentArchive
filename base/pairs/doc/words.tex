% A ConTeXt document [master document: pairs.tex]

\section[title=JoyLoL words]

\startTestSuite[initPairsCoAlgebra]

\startCHeader
extern void initPairsCoAlgebra(JoyLoLInterp* jInterp);
\stopCHeader

\startCCode

CoAlgHandle* car(CoAlgHandle* aLoL) {
  if (!aLoL) return NULL;
  if (aLoL->type && (aLoL->type->isA != PairsTag)) return aLoL;
  return aLoL->data.ptrs.a;
}

CoAlgHandle* cdr(CoAlgHandle* aLoL) {
  if (!aLoL) return NULL;
  if (aLoL->type && (aLoL->type->isA != PairsTag)) return NULL;
  return aLoL->data.ptrs.b;
}

CoAlgHandle* copyLoL(JoyLoLInterp* jInterp, CoAlgHandle* aLoL) {
  if (!aLoL) return NULL;
  if (isAtom(aLoL)) return aLoL;

  return newPair(jInterp,
                 copyLoL(jInterp, aLoL->data.ptrs.a),
                 copyLoL(jInterp, aLoL->data.ptrs.b));
}

size_t equalLoLDebug(CoAlgHandle* lolA, CoAlgHandle* lolB, size_t debugFlag) {
  DEBUG(debugFlag, "equalLoL %p %p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (isAtom(lolA)) {
    if (lolA->coAlg) {
      return (lolA->coAlg->equality)(lolA->coAlg, lolA, lolB, debugFlag);
    }
    return FALSE;
  }
  //
  if (!equalLoLDebug(lolA->data.ptrs.a, lolB->data.ptrs.a, debugFlag)) {
    return FALSE;
  }
  return equalLoLDebug(lolA->data.ptrs.b, lolB->data.ptrs.b, debugFlag);
}

size_t isPair(CoAlgHandle* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg && (aLoL->coAlg->isA != PairsTag)) return FALSE;
  return TRUE;
}

size_t isAtom(CoAlgHandle* aLoL) {
  if (!aLoL) return FALSE;
  if (aLoL->coAlg && (aLoL->coAlg->isA != PairsTag)) return TRUE;
  return FALSE;
}

static void isPairAP(Context* aCtx) {
  assert(aCtx);
  assert(aCtx->coAlgebras);
  popCtxDataInto(aCtx, top);
  CoAlgHandle* result = NULL;
  if (isPair(top)) result = newBoolean(aCtx->coAlgebras, TRUE);
  else             result = newBoolean(aCtx->coAlgebras, FALSE);
  pushCtxData(aCtx, result);
}

static void isAtomAP(Context* aCtx) {
  assert(aCtx);
  assert(aCtx->coAlgebras);
  popCtxDataInto(aCtx, top);
  CoAlgHandle* result = NULL;
  if (isAtom(top)) result = newBoolean(aCtx->coAlgebras, TRUE);
  else             result = newBoolean(aCtx->coAlgebras, FALSE);
  pushCtxData(aCtx, result);
}

static void popAP(Context* aCtx) {
  popCtxData(aCtx);
}

static void popProcessAP(Context* aCtx) {
  popCtxProcess(aCtx);
}

static void pop2ndAP(Context* aCtx) {
  popCtxDataInto(aCtx, top);
  popCtxData(aCtx);
  pushCtxData(aCtx, top);
}

static void pop2ndProcessAP(Context* aCtx) {
  popCtxProcessInto(aCtx, top);
  popCtxProcess(aCtx);
  pushCtxProcess(aCtx, top);
}

void initPairsCoAlgebra(JoyLoLInterp* jInterp) {
  extendJoyLoL(jInterp, "isPair",        isPairAP);
  extendJoyLoL(jInterp, "isAtom",        isAtomAP);
  extendJoyLoL(jInterp, "pop",           popAP);
  extendJoyLoL(jInterp, "popProcess",    popProcessAP);
  extendJoyLoL(jInterp, "pop2nd",        pop2ndAP);
  extendJoyLoL(jInterp, "pop2ndProcess", pop2ndProcessAP);
}
\stopCCode

\stopTestSuite
