% A ConTeXt document [master document: jInterps.tex]

\section[title=Conclusions]

\addDocumentDirectory{doc}

\createLuaCodeFile%
  {default}%
  {joylol.lua}%
  {-- A Lua file}

Before we actually we write out the \type{CoAlgs} C-header file, provide 
some standard definitions, the most important of which deal with 
memory allocation and alignment as well as a simple \type{DEBUG} system. 

\prependCHeader{public}
\startCHeader
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>
#include <assert.h>
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>

#ifndef JOYLOL_SYSTEM_CONFIG_PATH
#define JOYLOL_SYSTEM_CONFIG_PATH "/usr/local/etc/joyLoL"
#endif

#ifndef JOYLOL_SYSTEM_COALG_PATH
#define JOYLOL_SYSTEM_COALG_PATH "/usr/local/lib/joyLoL"
#endif

#ifndef JOYLOL_COALGS_INCREMENT
#define JOYLOL_COALGS_INCREMENT 10
#endif
 
#ifndef NULL
#define NULL (void*)0
#endif

#ifndef TRUE
#define TRUE 1
#endif
#ifndef FALSE
#define FALSE 0
#endif

#ifdef __LP64__
#define MEM_ALIGNMENT ((size_t)0x7)
#else
#define MEM_ALIGNMENT ((size_t)0x3)
#endif
#define IS_MEM_ALIGNED(someMem) \
  (!( ((size_t)(someMem)) & (MEM_ALIGNMENT) ))

#define joyLoLCalloc(numItems, itemType) \
  (itemType*)calloc((numItems), sizeof(itemType))

#ifndef NDEBUG
#include <stdio.h>
#define DEBUG(debugFlag, format, ... ) \
  if (debugFlag) { printf( format, __VA_ARGS__ ); fflush(stdout); }
#else
#define DEBUG(...)
#endif
\stopCHeader

\CHeaderIncludeGuard{public}{JOYLOL_COALG_COALGS}
\createCHeaderFile%
  {public}%
  {joylol/jInterps.h}%
  {}

\CHeaderIncludeGuard{private}{JOYLOL_COALG_COALGS_PRIVATE}
\createCHeaderFile%
  {private}%
  {joylol/jInterps-private.h}%
  {}

\setCCodeStream{objects}
\prependCCode{objects}
\startCCode
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joylol/jInterps.h"
#include "joylol/jInterps-private.h"
\stopCCode

\createCCodeFile%
  {objects}%
  {objects.c}%
  {}

\prependCCode{interpreter}
\startCCode
#include <stdlib.h>
#include <assert.h>

#include <joylol/jInterps.h>
#include "joylol/jInterps-private.h"
\stopCCode

\createCCodeFile%
  {interpreter}%
  {interpreter.c}%
  {}

\setCCodeStream{words}
\prependCCode{words}
\startCCode
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joylol/jInterps.h"
#include "joylol/jInterps-private.h"
\stopCCode

\createCCodeFile%
  {words}%
  {words.c}%
  {}

\setCCodeStream{lua}
\prependCCode{lua}
\startCCode
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "joylol/jInterps.h"
#include "joylol/jInterps-private.h"
\stopCCode

\createCCodeFile%
  {lua}%
  {lua.c}%
  {}

\addCTestInclude{<joylol/jInterps.h>}
\addCTestInclude{<joylol/jInterps-private.h>}
\addCTestInclude{<joylol/symbols.h>}
\addCTestInclude{<joylol/stringBuffers.h>}
\addCTestLib{<HOME>/.joylol/joylol/symbols}
\addCTestLib{<HOME>/.joylol/joylol/stringBuffers}
\CTestsSetup\
\startCTest
  requireStaticallyLinkedJInterps(lstate);
  requireStaticallyLinkedSymbols(lstate);
  requireStaticallyLinkedStringBuffers(lstate);
  getJoyLoLInterpInto(lstate, jInterp);
\stopCTest
\createCTestFile%
  {default}%
  {allCTests.c}%
  {}

\addMainDocument{jInterps.tex}
\addSubDocument{overview.tex} 
\addSubDocument{objects.tex}
\addSubDocument{interpreter.tex}
%\addSubDocument{printer.tex}
\addSubDocument{words.tex}
\addSubDocument{luaInterface.tex}
\addSubDocument{luaScript.tex}
\addSubDocument{conclusion.tex} 
\addConTeXtModuleDirectory{install}

\startLmsfile
local joylolTarget = makePath{getEnv('HOME'), '.joylol', 'joylol.lua'}
local joylolDep    = makePath{'build', 'joylol.lua'}
tInsert(installTargets, target{
  target       = joylolTarget,
  dependencies = { joylolDep },
  command      = tConcat({'install -T', joylolDep, joylolTarget }, ' ')
})
\stopLmsfile

\addCTestTargets{default}

\addJoyLoLTargets{default}

\compileLmsfile{default}

\createLmsfileFile%
  {default}%
  {lmsfile}%
  {-- A Lua Make System file}

