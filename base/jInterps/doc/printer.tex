% A ConTeXt document [master document: jInterps.tex]

\section[title=Printer]

\startCCode
// We need to protect our list walking printer from the possibility that a
// structure (and dictionaries will be) contain cycles...
//
// We do this by re-using the garbage collector's mark-sweep bit.
// This is crude and will certainly need to be chaged at some point...
// but it should work now... the likely future change will be to add
// further fields to the PairAtom structure.
// (or to use a hash table).
\stopCCode

\startTestSuite[compute print size]

\startCHeader
extern size_t printSizeDebug(
  CoAlgObj* aLoL,
  Boolean debugFlag
);

#define printSize(aLoL)      \
  printSizeDebug(aLoL, FALSE)
\stopCHeader

\startCCode
size_t printSizeDebug(
  CoAlgObj* aLoL,
  Boolean debugFlag
) {  
  DEBUG(debugFlag, "printSize-wrapper: > %p \n", aLoL);
  size_t result = 0;
  if (aLoL) {
    assert(aLoL->type);
    result = (aLoL->type->printSize)(aLoL, debugFlag);
  } else result = 5;
  DEBUG(debugFlag, "printSize-wrapper: < %p %zu\n", aLoL, result);
  return result;
}
\stopCCode

\startCHeader
extern void clearPrintSizeMarksDebug(
  CoAlgObj* aLoL,
  Boolean debugFlag
);
\stopCHeader

\startCCode
// We need to know the structure of the PairsObj
// 
#include <joylol/pairs.h>

void clearPrintSizeMarksDebug(
  CoAlgObj* aLoL,
  Boolean debugFlag
) {
  if (!aLoL) return;

  if (!(aLoL->flags & PRINT_FLAG)) return;
  aLoL->flags = aLoL->flags & (~ PRINT_FLAG);

  if (aLoL->tag != PairsTag) return;

  clearPrintSizeMarksDebug(asCar(aLoL), debugFlag);

  if (asCdr(aLoL)) {
    clearPrintSizeMarksDebug(asCdr(aLoL), debugFlag);
  }
}
\stopCCode

\startTestCase[printSize Of NULL]
\startCTest
  AssertIntEquals(printSize(NULL), 5);
\stopCTest
\stopTestCase
\stopTestSuite

\startCHeader
extern char* printLoLDebug(
  CoAlgObj* aLoL,
  Boolean debugFlag
);

#define printLoL(aLoL)      \
  printLoLDebug(aLoL, FALSE)
\stopCHeader

\startCCode
char* printLoLDebug(
  CoAlgObj* aLoL, 
  Boolean debugFlag
) {
  //  debugFlag = TRUE;
  DEBUG(debugFlag, "printLoL %p\n", aLoL);
  size_t bufferSize = printSizeDebug(aLoL, debugFlag) + 10;
  DEBUG(debugFlag, "printLoL size:%zu %p\n", bufferSize, aLoL);

  char* buffer = (char*) calloc(bufferSize, sizeof(char));
  assert(buffer);

  DEBUG(debugFlag, "printLoL strlen(0) %zu %p\n", strlen(buffer), aLoL);
  if (aLoL) {
    assert(aLoL->type);
    Boolean result = (aLoL->type->printStr)(aLoL, buffer, bufferSize);
    assert(result);
  } else strcat(buffer, "null ");
  DEBUG(debugFlag, "printLoL strlen(1) %zu %p\n", strlen(buffer), aLoL);

  buffer[strlen(buffer)-1] = 0; // remove the trailing space

  return buffer;
}
\stopCCode