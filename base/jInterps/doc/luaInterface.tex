% A ConTeXt document [master document: jInterps.tex]

\section[title=Lua interface functions]
\setCCodeStream{lua}

\component gitVersion-c

\startCCode
static int lua_jInterps_getGitVersion (lua_State *lstate) {
  Symbol* aKey   = lua_tostring(lstate, 1);
  if (aKey) {
    getGitVersionInto(gitVersionKeyValues, aKey, aValue);
    lua_pushstring(lstate, aValue);
  } else {
    lua_pushstring(lstate, "no valid key provided");
  }
  return 1;
}
\stopCCode

\startCCode
static int lua_joylol_setVerbose(lua_State *lstate) {
  Boolean verbose = 
    (lua_toboolean(lstate, 1) ? TRUE : FALSE);
  getJoyLoLInterpInto(lstate, jInterp);
  assert(jInterp);
  assert(jInterp->rootCtx);
  jInterp->verbose = verbose;
  jInterp->rootCtx->verbose = verbose;
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_setDebugging(lua_State *lstate) {
  Boolean debugFlag = 
    (lua_toboolean(lstate, 1) ? TRUE : FALSE);
  getJoyLoLInterpInto(lstate, jInterp);
  assert(jInterp);
  jInterp->debug = debugFlag;
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_pushLoadPath(lua_State *lstate) {
  Symbol *aPath = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  pushLoadPath(jInterp->loader, aPath);
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_loadFile(lua_State *lstate) {
  Symbol *aFile = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  loadAFile(jInterp->rootCtx, aFile);
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_pushNullData(lua_State *lstate) {
  getJoyLoLInterpInto(lstate, jInterp);
  pushNullCtxData(jInterp->rootCtx);
  return 0;
}

static int lua_joylol_pushSymbolData(lua_State *lstate) {
  Symbol *aString = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  pushSymbolCtxData(jInterp->rootCtx, aString);
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_pushParsedStringData(lua_State *lstate) {
  Symbol *aString = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  pushParsedStringCtxData(jInterp->rootCtx, aString);
  lua_pop(lstate, 1);
  return 0;
}

//popData
//peekData

static int lua_joylol_pushNullProcess(lua_State *lstate) {
  //getJoyLoLInterpInto(lstate, jInterp);
  //pushNullCtxProcess(jInterp->rootCtx);
  return 0;
}

static int lua_joylol_pushSymbolProcess(lua_State *lstate) {
  Symbol *aString = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  pushSymbolCtxProcess(jInterp->rootCtx, aString);
  lua_pop(lstate, 1);
  return 0;
}


static int lua_joylol_pushParsedStringProcess(lua_State *lstate) {
  Symbol *aString = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  pushParsedStringCtxProcess(jInterp->rootCtx, aString);
  lua_pop(lstate, 1);
  return 0;
}

//popProcess
//peekProcess

static int lua_joylol_evalString(lua_State *lstate) {
  Symbol *aString = lua_tostring(lstate, 1);
  getJoyLoLInterpInto(lstate, jInterp);
  evalStringInContext(jInterp->rootCtx, aString);
  lua_pop(lstate, 1);
  return 0;
}

static int lua_joylol_eval(lua_State *lstate) {
  getJoyLoLInterpInto(lstate, jInterp);
  evalContext(jInterp->rootCtx);
  return 0;
}

#define NumJoyLoLInterfaceFunctions 15
static const struct luaL_Reg lua_joylol_interface [] = {
  { "gitVersion",              lua_jInterps_getGitVersion         },
  { "setVerbose",              lua_joylol_setVerbose              },
  { "setDebugging",            lua_joylol_setDebugging            },
  { "pushLoadPath",            lua_joylol_pushLoadPath            },
  { "loadFile",                lua_joylol_loadFile                },
  { "pushNullData",            lua_joylol_pushNullData            },
  { "pushSymbolData",          lua_joylol_pushSymbolData          },
  { "pushParsedStringData",    lua_joylol_pushParsedStringData    },
//  { "popData",                 lua_joylol_popData                 },
//  { "peekData",                lua_joylol_peekData                },
  { "pushNullProcess",         lua_joylol_pushNullProcess         },
  { "pushSymbolProcess",       lua_joylol_pushSymbolProcess       },
  { "pushParsedStringProcess", lua_joylol_pushParsedStringProcess },
//  { "popProcess",              lua_joylol_popProcess              },
//  { "peekProcess",             lua_joylol_peekProcess             },
  { "evalString",              lua_joylol_evalString              },
  { "eval",                    lua_joylol_eval                    },
  {NULL, NULL}
};
\stopCCode
