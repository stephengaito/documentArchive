% A ConTeXt document [master document: coAlgs.tex]

\section[title=Lakefile]

We use a slightly updated version of Steve Donovan's Lakefile tool to 
drive the creation of the various files required by any given 
\type{t-joylol} managed \ConTeXt\ module. 

\startLakefile
-- A Lua Lakefile

local docDir    = 'doc'
local srcFiles = {
  docDir..'/coAlgs.tex',
  docDir..'/overview.tex',
  docDir..'/classCode.tex',
  docDir..'/instanceCode.tex',
  docDir..'/lakefile.tex'
}

local coAlgsDoc = 
  'cd '..docDir..' ; context coAlgs.tex'
--  'cd '..docDir..' ; context -once coAlgs.tex ; diSimp bib ; context coAlgs.tex'

local moduleTargets = {
  'coAlgs.h',
  'coAlgs-private.h',
  'coAlgs-class.c',
  'coAlgs-instance.c'
}

local testExecs = {
  'allCTests'
}

local buildTargets   = { }
local diffTargets    = { }
local testTargets    = { }

for i, aTarget in ipairs(moduleTargets) do

  table.insert(buildTargets, target(
    'build/'..aTarget,
    srcFiles,
    coAlgsDoc
  ))

end

for i, anExec in ipairs(testExecs) do

  table.insert(buildTargets, target(
    'build/'..anExec..'.c',
    srcFiles,
    coAlgsDoc
  ))

  c.program{
    'build/'..anExec,
    src=anExec..'.c',
    cdir='build',
    needs='lua5.2'
  }
  
  table.insert(testTargets, target(
    'build/'..anExec..'-results.lua',
    'build/'..anExec,
    './build/'..anExec
  ))
end

table.insert(buildTargets, target(
  'build/lakefile',
  srcFiles,
  coAlgsDoc
))

target('tests', testTargets)

default(buildTargets)
\stopLakefile

\createLakefileFile%
  {default}%
  {../lakefile}%
  {}
