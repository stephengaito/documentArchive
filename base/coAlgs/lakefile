-- A Lua Lakefile

local docDir    = 'doc'
local sharedLib = 'coAlgs.so'
local srcFiles = {
  docDir..'/coAlgs.tex',
  docDir..'/overview.tex',
  docDir..'/classCode.tex',
  docDir..'/instanceCode.tex',
  docDir..'/lakefile.tex'
}

local coAlgsDoc =
  'cd '..docDir..' ; context coAlgs.tex'
--  'cd '..docDir..' ; context -once coAlgs.tex ; diSimp bib ; context coAlgs.tex'

local moduleTargets = {
  'coAlgs.h',
  'coAlgs-private.h',
  'coAlgs-class.c',
  'coAlgs-instance.c'
}

local testExecs = {
  'allCTests'
}

local buildTargets   = { }
local testTargets    = { }

for i, aTarget in ipairs(moduleTargets) do

  table.insert(buildTargets, target(
    'build/'..aTarget,
    srcFiles,
    coAlgsDoc
  ))

end

local sharedTarget = c.shared{
  sharedLib,
  src='*.c',
  cdir='build',
  needs='lua5.2'
}

table.insert(buildTargets, sharedTarget.target)

for i, anExec in ipairs(testExecs) do

  table.insert(buildTargets, target(
    'build/'..anExec..'.c',
    srcFiles,
    coAlgsDoc
  ))

  local testTarget = c.program{
    'build/'..anExec,
    src={anExec..'.c', 'build/'..sharedLib },
    cdir='build',
    needs='lua5.2'
  }
 
  table.insert(testTargets, target(
    'build/'..anExec..'-results.lua',
    testTarget.target,
    './build/'..anExec
  ))
end

table.insert(buildTargets, target(
  'build/lakefile',
  srcFiles,
  coAlgsDoc
))

target('tests', testTargets)

default(buildTargets)