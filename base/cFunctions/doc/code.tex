% A ConTeXt document [master document: cFunctions.tex]

\section[title=Code]

\dependsOn[jInterps]
%\dependsOn[context]
%\dependsOn[boolean]
\setCHeaderStream{public}

\startCHeader
typedef struct context_object_struct ContextObj;
typedef void (CFunction)(ContextObj*);

typedef struct cFunction_object_struct {
  CoAlgObj   super;
  CFunction *func;
} CFunctionObj;

#define asCFunc(aLoL) (((CFunctionObj*)(aLoL))->func)
\stopCHeader

\startTestSuite[newCFunction]

\startCHeader
CFunctionObj *newCFunction(
  JoyLoLInterp *jInterp,
  CFunction *aFunc
);
\stopCHeader

\startCCode
CFunctionObj *newCFunction(
  JoyLoLInterp *jInterp,
  CFunction *aFunc
) {
  assert(jInterp);
  CFunctionObj* aNewFunc =
    (CFunctionObj*)newObject(jInterp, CFunctionsTag);
  assert(aNewFunc);
  aNewFunc->func  = aFunc;
  return aNewFunc;
}
\stopCCode

\CTestsSetup\
\startCTest
  void testCFunction(ContextObj* aCtx) { }
\stopCTest

\startTestCase[should create a new CFunction]
\startCTest
  AssertPtrNotNull(jInterp);

  CFunctionObj *aNewFunc =
    newCFunction(jInterp, testCFunction);
  AssertPtrNotNull(aNewFunc);
  AssertPtrNotEquals((void*)aNewFunc, (void*)testCFunction);
  AssertPtrNotNull(aNewFunc->super.type);
  AssertIntEquals(aNewFunc->super.tag, CFunctionsTag);
  AssertPtrEquals(aNewFunc->func, testCFunction);
  AssertIntTrue(isCFunction((CoAlgObj*)aNewFunc));
  AssertIntTrue(isAtom((CoAlgObj*)aNewFunc));
  AssertIntFalse(isPair((CoAlgObj*)aNewFunc));
\stopCTest
\stopTestCase
\stopTestSuite

\startCHeader
#define isCFunction(aLoL)               \
  (                                     \
    (                                   \
      (aLoL) &&                         \
      asType(aLoL) &&                   \
      (asTag(aLoL) == CFunctionsTag) && \
       asCFunc(aLoL)                    \
    ) ?                                 \
      TRUE :                            \
      FALSE                             \
  )

\stopCHeader

\setCHeaderStream{private}
\startCHeader
Boolean equalityFuncCoAlg(
  CoAlgObj* lolA,
  CoAlgObj* lolB,
  Boolean debugFlag
);
\stopCHeader

\startCCode
Boolean equalityFuncCoAlg(
  CoAlgObj* lolA,
  CoAlgObj* lolB,
  Boolean debugFlag
) {
  DEBUG(debugFlag, "funcCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (asType(lolA) != asType(lolB)) return FALSE;
  if (!asType(lolA)) return FALSE;
  if (asTag(lolA) != CFunctionsTag) return FALSE;
  if (asCFunc(lolA) != asCFunc(lolB)) return FALSE;
  return TRUE;
}
\stopCCode

\startTestSuite[print CFunction]

\startCHeader
extern Boolean printFuncCoAlg(
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
);
\stopCHeader

\startCCode
Boolean printFuncCoAlg(
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
) {
  assert(aLoL);
  assert(asTag(aLoL) == CFunctionsTag);

  char ptoa[100];
  sprintf(ptoa, "<%p> ", asCFunc(aLoL));
  strBufPrintf(aStrBuf, ptoa);
  return TRUE;
}
\stopCCode

\startTestCase[should print CFuncion]
\startCTest
  AssertPtrNotNull(jInterp);

  char buffer[100];
  buffer[0] = 0;
  sprintf((char*)&buffer, "<%p> ", testCFunction);

  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  AssertPtrNotNull(aStrBuf);
  
  CoAlgObj* aNewFunc =
    (CoAlgObj*)newCFunction(jInterp, testCFunction);
  AssertPtrNotNull(aNewFunc);
  printLoLDebug(aStrBuf, aNewFunc, FALSE);
  AssertStrEquals(getCString(aStrBuf), buffer);
  strBufClose(aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite

\starttyping
// suiteName: - Functions CoAlgebra tests -

void Test_checkFunctionsSymbols(CuTest* tc) {
  CoAlgebras* coAlgs = createCoAlgebras();
  CuAssertPtrNotNull(tc, coAlgs);

  Symbols* symbols = coAlgs->symbols;
  CuAssertPtrNotNull(tc, symbols);
  Dictionary* mainDic = symbols->dictionary;
  CuAssertPtrNotNull(tc, mainDic);

  AVLNode* aNode = findSymbol(mainDic, "isFunction");
  CuAssertPtrNotNull(tc, aNode);
  CuAssertStrEquals(tc, aNode->symbol, "isFunction");
  CuAssertPtrNotNull(tc, aNode->value);
  CuAssertTrue(tc, isFunction(aNode->value));
}
\stoptyping

\startTestSuite[registerCFunctions]

\setCHeaderStream{private}
\startCHeader
extern Boolean registerCFunctions(JoyLoLInterp *jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean registerCFunctions(JoyLoLInterp *jInterp) {
  CoAlgebra* theCoAlg    = (CoAlgebra*) calloc(1, sizeof(CoAlgebra));
  theCoAlg->name         = CFunctionsName;
  theCoAlg->objectSize   = sizeof(CFunctionObj);
  theCoAlg->registerFunc = registerCFunctions;
  theCoAlg->equalityFunc = equalityFuncCoAlg;
  theCoAlg->printStr     = printFuncCoAlg;
  size_t tag = registerCoAlgebra(jInterp, theCoAlg);

  // do a sanity check...
  assert(tag == CFunctionsTag);
  assert(jInterp->coAlgs[tag].sClass);
  
  registerCFunctionWords(jInterp);
  
  return TRUE;
}
\stopCCode

\startTestCase[should register cFunctions]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerCFunctions
  
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(jInterp->coAlgs[CFunctionsTag].sClass);
  CoAlgebra *coAlg = jInterp->coAlgs[CFunctionsTag].sClass;
  //AssertIntTrue(registerCFunctions(jInterp));
  AssertPtrNotNull(jInterp->coAlgs[CFunctionsTag].sClass);
  AssertPtrEquals(jInterp->coAlgs[CFunctionsTag].sClass, coAlg);
  AssertIntEquals(
    jInterp->coAlgs[CFunctionsTag].sClass->objectSize,
    sizeof(CFunctionObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite