% A ConTeXt document [master document: contexts.tex]

\section[title=Context core definition code]
\setCHeaderStream{public}

\startCHeader
typedef Boolean (ExtendJoyLoL)(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  CFunction    *aFunc
);

#define extendJoyLoL(jInterp, definedName, aFunc)       \
  (                                                     \
    assert(getContextsClass(jInterp)                    \
      ->extendJoyLoLFunc),                              \
    (getContextsClass(jInterp)                          \
      ->extendJoyLoLFunc(jInterp, definedName, aFunc))  \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean extendJoyLoLImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  CFunction    *aFunc
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean extendJoyLoLImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  CFunction    *aFunc
) {
  assert(jInterp);
  assert(jInterp->rootCtx);
  DictNodeObj* aSym =
    createSymbol(jInterp->rootCtx->dict, definedName);
  aSym->value =
    (JObj*)newCFunction(jInterp, aFunc);

  return TRUE;
}
\stopCCode

\startCHeader
typedef Boolean (DefineJoyLoL)(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  JObj     *aLoL
);

#define defineJoyLoL(jInterp, definedName, aLoL)      \
  (                                                   \
    assert(getContextsClass(jInterp)                  \
      ->defineJoyLoLFunc),                            \
    (getContextsClass(jInterp)                        \
      ->defineJoyLoLFunc(jInterp, definedName, aLoL)) \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean defineJoyLoLImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  JObj     *aLoL
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean defineJoyLoLImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  JObj     *aLoL
) {
  assert(jInterp);
  assert(jInterp->rootCtx);
  DictNodeObj* aSym =
    createSymbol(jInterp->rootCtx->dict, definedName);
  aSym->value = copyLoL(jInterp, aLoL);

  return TRUE;
}
\stopCCode

\startCHeader
typedef Boolean (DefineContext)(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  ContextObj   *newCtx
);

#define defineContext(jInterp, definedName, newCtx)       \
  (                                                       \
    assert(getContextsClass(jInterp)                      \
      ->defineContextFunc),                               \
    (getContextsClass(jInterp)                            \
      ->defineContextFunc(jInterp, definedName, newCtx))  \
  )
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean defineContextImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  ContextObj   *newCtx
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean defineContextImpl(
  JoyLoLInterp *jInterp,
  Symbol       *definedName,
  ContextObj   *newCtx
) {
  DEBUG(jInterp, "defineContext %p [%s] %p\n",
        jInterp, definedName, newCtx);
  assert(jInterp);
  assert(jInterp->rootCtx);
  DictNodeObj* aSym =
    createSymbol(jInterp->rootCtx->dict, definedName);
  aSym->value   = (JObj*)newCtx;

  return TRUE;
}
\stopCCode
