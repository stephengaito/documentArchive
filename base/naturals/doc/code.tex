% A ConTeXt document [master document: symbols.tex]

\section[title=Code]
\setCHeaderStream{public}

\dependsOn[jInterps]
%\dependsOn[context]

\startCHeader
#include <gmp.h>
typedef mpz_t Natural;

typedef struct natural_object_struct {
  CoAlgObj super;
  Natural  natural;
} NaturalObj;

#define asNatural(aObj) (((NaturalObj*)(aObj))->natural)
\stopCHeader

\startTestSuite[newNatural]

\startCHeader
CoAlgObj* newNatural(JoyLoLInterp* jInterp, Symbol* aNatural);
\stopCHeader

\startCCode
CoAlgObj* newNatural(JoyLoLInterp* jInterp, Symbol* aNatural) {
  assert(aNatural);
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  CoAlgObj* result = newObject(jInterp, NaturalsTag);
  assert(result);
  if (aNatural) {
    long success = mpz_set_str(asNatural(result), aNatural, 0);
    assert(success == 0);
  } else mpz_init(asNatural(result));
  return result;
}
\stopCCode

\startTestCase[should create some new naturals]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);

  const char* testNum = "12345";
  CoAlgObj* aNewNat = newNatural(jInterp, testNum);
  AssertPtrNotNull(aNewNat);
  AssertPtrNotNull(asType(aNewNat));
  AssertIntEquals(asTag(aNewNat), NaturalsTag);
  AssertIntTrue(isAtom(aNewNat));
  AssertIntFalse(isPair(aNewNat));
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[isNatural]

\startCHeader
#define isNatural(aLoL)             \
  (                                 \
    (                               \
      (aLoL) &&                     \
      asType(aLoL) &&               \
      (asTag(aLoL) == NaturalsTag)  \
    ) ?                             \
      TRUE :                        \
      FALSE                         \
  )
\stopCHeader

\startTestCase[should return true if a natural]

\startCTest
  CoAlgObj *aNat = newNatural(jInterp, "12345");
  AssertIntTrue(isNatural(aNat));
\stopCTest
\stopTestCase

\startTestCase[should return false if not a symbol]
\startCTest
  AssertIntFalse(isNatural(NULL));
  CoAlgObj *aObj = newObject(jInterp, BooleansTag);
  AssertIntFalse(isNatural(aObj));
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[natural equality]

\setCHeaderStream{private}
\startCHeader
Boolean equalityNatCoAlgDebug(
  CoAlgObj* lolA,
  CoAlgObj* lolB,
  Boolean debugFlag
);

#define equalityNatCoAlg(lolA, lolB) \
  equalityNatCoAlgDebug(lolA, lolB, FALSE)
\stopCHeader

\startCCode
Boolean equalityNatCoAlgDebug(CoAlgObj* lolA, CoAlgObj* lolB,
                              size_t debugFlag) {
  DEBUG(debugFlag, "natCoAlg-equal a:%p b:%p\n", lolA, lolB);
  if (!lolA && !lolB) return TRUE;
  if (!lolA && lolB)  return FALSE;
  if (lolA  && !lolB) return FALSE;
  if (asType(lolA) != asType(lolB)) return FALSE;
  if (!asType(lolA)) return FALSE;
  if (asTag(lolA) != NaturalsTag) return FALSE;
  if (mpz_cmp(asNatural(lolA), asNatural(lolB)) != 0) return FALSE;
  return TRUE;
}
\stopCCode

\startTestCase[should return true if naturals are equal]

\startCTest
  AssertIntTrue(equalityNatCoAlg(NULL, NULL));
  CoAlgObj *natA = newNatural(jInterp, "12345");
  CoAlgObj *natB = newNatural(jInterp, "12345");
  AssertIntTrue(equalityNatCoAlg(natA, natB));
\stopCTest
\stopTestCase

\startTestCase[should return false if symbols are not equal]

\startCTest
  CoAlgObj *natA = newNatural(jInterp, "12346");
  CoAlgObj *natB = newNatural(jInterp, "12345");
  AssertIntFalse(equalityNatCoAlg(NULL, natB));
  AssertIntFalse(equalityNatCoAlg(natA, NULL));
  AssertIntFalse(equalityNatCoAlg(natA, natB));
\stopCTest
\stopTestCase
\stopTestSuite


\startTestSuite[printing symbols]

\setCHeaderStream{private}
\startCHeader
extern Boolean printNatCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean printNatCoAlg(
  JoyLoLInterp    *jInterp,
  StringBufferObj *aStrBuf,
  CoAlgObj        *aLoL
) {
  assert(aLoL);
  assert(asTag(aLoL) == NaturalsTag);

  char* mpztoa;
  mpztoa = NULL;
  long numChars = gmp_asprintf(&mpztoa, "%Zd ", asNatural(aLoL));
  assert(0 < numChars);
  strBufPrintf(jInterp, aStrBuf, mpztoa);
  free(mpztoa);
  return TRUE;
}
\stopCCode

\startTestCase[should print symbols]

\startCTest
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs[NaturalsTag].sClass);

  const char* testNum = "12345 ";
  CoAlgObj* aNewNat = newNatural(jInterp, testNum);
  AssertPtrNotNull(aNewNat);
  StringBufferObj *aStrBuf = newStringBuffer(jInterp);
  printNatCoAlg(jInterp, aStrBuf, aNewNat);
  AssertStrEquals(getCString(jInterp, aStrBuf), testNum);
  strBufClose(jInterp, aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[registerSymbols]

\startCHeader
typedef struct naturals_class_struct {
  CoAlgClass super;
} NaturalsClass;
\stopCHeader

\setCHeaderStream{private}
\startCHeader
extern Boolean registerNaturals(JoyLoLInterp* jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
Boolean registerNaturals(JoyLoLInterp* jInterp) {
  assert(jInterp);
  assert(jInterp->coAlgs);
  
  NaturalsClass* theCoAlg      = joyLoLCalloc(1, NaturalsClass);
  theCoAlg->super.name         = "Naturals";
  theCoAlg->super.objectSize   = sizeof(NaturalObj);
  theCoAlg->super.registerFunc = registerNaturals;
  theCoAlg->super.equalityFunc = equalityNatCoAlgDebug;
  theCoAlg->super.printFunc    = printNatCoAlg;
  
  size_t tag =
    registerCoAlgClass(jInterp, (CoAlgClass*)theCoAlg);
  
  // sanity check...
  assert(tag == NaturalsTag);
  assert(jInterp->coAlgs[tag].sClass);

  registerNaturalWords(jInterp);

  return TRUE;
}
\stopCCode

\startTestCase[should register the Naturals coAlg]

\startCTest
  // CTestsSetup has already created a jInterp
  // and run registerSymbols
  AssertPtrNotNull(jInterp);
  AssertPtrNotNull(jInterp->coAlgs);
  AssertPtrNotNull(getNaturalsClass(jInterp));
  NaturalsClass *coAlg = getNaturalsClass(jInterp);
  AssertIntTrue(registerNaturals(jInterp));
  AssertPtrNotNull(getNaturalsClass(jInterp));
  AssertPtrEquals(getNaturalsClass(jInterp), coAlg);
  AssertIntEquals(
    getNaturalsClass(jInterp)->super.objectSize,
    sizeof(NaturalObj)
  )
\stopCTest
\stopTestCase
\stopTestSuite
