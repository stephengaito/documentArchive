% A ConTeXt document [master document: naturals.tex]

\section[title=Words]

\startCCode
static void addAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  if (!isNatural(top1) || !isNatural(top2)) {
    raiseException(aCtx,
      "addition requires that the top two stack elements are naturals"
    );
    return;
  }
  JObj* sum = newNatural(jInterp, NULL);
  mpz_add(asNatural(sum), asNatural(top1), asNatural(top2));
  pushCtxData(aCtx, sum);
}
\stopCCode

\startCCode
static void subtractAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  if (!isNatural(top1) || !isNatural(top2)) {
    raiseException(aCtx,
      "subtraction requires that the top two stack elements are naturals"
    );
    return;
  }
  JObj* difference = newNatural(jInterp, NULL);
  if (asNatural(top2) < asNatural(top1)) {
    mpz_sub(asNatural(difference), asNatural(top1), asNatural(top2));
  }
  pushCtxData(aCtx, difference);
}
\stopCCode

\startCCode
static void subtractReverseAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  if (!isNatural(top1) || !isNatural(top2)) {
    raiseException(aCtx,
      "(reverse) subtraction requires that the top two stack elements are naturals"
    );
    return;
  }
  JObj* difference = newNatural(jInterp, NULL);
  if (asNatural(top1) < asNatural(top2)) {
    mpz_sub(asNatural(difference), asNatural(top2), asNatural(top1));
  }
  pushCtxData(aCtx, difference);
}
\stopCCode

\startCCode
static void multiplyAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  if (!isNatural(top1) || !isNatural(top2)) {
    raiseException(aCtx,
      "multiplication requires that the top two stack elements are naturals"
    );
    return;
  }
  JObj* product = newNatural(jInterp, NULL);
  mpz_mul(asNatural(product), asNatural(top1), asNatural(top2));
  pushCtxData(aCtx, product);
}
\stopCCode

\startCCode
static void equalNatAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top1);
  popCtxDataInto(aCtx, top2);
  Boolean result = FALSE;
  if (isNatural(top1) &&
      isNatural(top2) &&
      (mpz_cmp(asNatural(top1), asNatural(top2)) == 0)) result = TRUE;
  DEBUG(jInterp, "equalNat: %zu\n", result);
  pushCtxData(aCtx, newBoolean(jInterp, result));
}
\stopCCode

\startCCode
static  mpz_t zero;

static void isZeroAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top);
  size_t result = FALSE;
  if (isNatural(top) &&
      (mpz_cmp(asNatural(top), zero) == 0)) result = TRUE;
  pushCtxData(aCtx, newBoolean(jInterp, result));
}
\stopCCode

\startCCode
static void isNaturalAP(ContextObj* aCtx) {
  assert(aCtx);
  JoyLoLInterp *jInterp = aCtx->jInterp;
  assert(jInterp);
  popCtxDataInto(aCtx, top);
  JObj* result = NULL;
  if (isNatural(top))
    result = newBoolean(jInterp, TRUE);
  else
    result = newBoolean(jInterp, FALSE);
  pushCtxData(aCtx, result);
}
\stopCCode

\setCHeaderStream{private}
\startCHeader
extern void registerNaturalWords(JoyLoLInterp* jInterp);
\stopCHeader
\setCHeaderStream{public}

\startCCode
void registerNaturalWords(JoyLoLInterp* jInterp) {
  mpz_init(zero);
  extendJoyLoL(jInterp, "isNatural", isNaturalAP);
  extendJoyLoL(jInterp, "+",         addAP);
  extendJoyLoL(jInterp, "-",         subtractAP);
  extendJoyLoL(jInterp, "-rev",      subtractReverseAP);
  extendJoyLoL(jInterp, "*",         multiplyAP);
  extendJoyLoL(jInterp, "=nat",      equalNatAP);
  extendJoyLoL(jInterp, "isZero",    isZeroAP);
}
\stopCCode
