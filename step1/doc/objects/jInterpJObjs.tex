% A ConTeXt document [master document: ../jInterp.tex ]

\subsection[title=JObjects]

\startCHeader
typedef struct jObject_struct {
  size_t tag;
} JObj;

#define isJObj(anObj) \
  ((anObj) && ((((JObj*)(anObj))->tag) == JObjTag))
#define asJObj(anObj)  ((JObj*)(anObj))
#define getJObjTag(anObj)  (((JObj*)(anObj))->tag)
#define hasValidJObjTag(anObj) (getJObjTag(anObj) < LAST_JOBJ_TAG)
#define getJObjName(anObj) \
  ((anObj) ? (jObjTagNameMap[getJObjTag(anObj)].name) : "null")
#define hasJObjPrinter(anObj)                   \
  ((anObj) &&                                   \
   hasValidJObjTag(anObj) &&       \
   (jObjTagNameMap[getJObjTag(anObj)].printer)  \ 
  )
#define getJObjPrinter(anObj) (jObjTagNameMap[getJObjTag(anObj)].printer) 
\stopCHeader

\startTestSuite[newJObject]

\startCHeader
JObj *newJObject(void);
\stopCHeader

\startCCode
JObj *newJObject(void) {
  JObj *newObj =
    (JObj*)calloc(1, sizeof(JObj));
  newObj->tag = JObjTag;
  return newObj;
}
\stopCCode

\startTestCase[should create a new jObj]

\startCTest
  JObj *aJObj = newJObject();
  AssertIntTrue(isJObj(aJObj));
  AssertIntEquals(getJObjTag(aJObj), JObjTag);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[printJObj]

\startCHeader
void printJObj(
  StringBufferObj *aStrBuf,
  JObj            *anObj, 
  Symbol          *indent,
  size_t           timeToLive
);
\stopCHeader

\startCCode
void printJObj(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
) {
  DEBUG(DebugMask, "printJObj %p\n", anObj);
  if (!anObj) {
    printf("%s<null>: null\n", indent);
    return;
  }
  
  assert(anObj->tag < LAST_JOBJ_TAG);
  
  jObjTagNameMap[getJObjTag(anObj)].printer(
    aStrBuf,
    anObj,
    indent,
    timeToLive
  );
}
\stopCCode

\startTestCase[should print null]

\skipTestCase
\stopTestSuite

\startTestSuite[jObjPrinter]

\startCHeader
void jObjPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t          timeToLive
);
\stopCHeader

\startCCode
void jObjPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
) {
  DEBUG(DebugMask, "jObjPrinter %p\n", anObj);
  assert(isStringBufferObj(aStrBuf));
  assert(isJObj(anObj));
  strBufPrintf(aStrBuf, "%s[JObj:%p]\n", indent, anObj);
}
\stopCCode

\startTestCase[should print a jObj]

\skipTestCase
\stopTestSuite