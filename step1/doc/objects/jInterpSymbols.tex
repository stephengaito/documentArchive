% A ConTeXt document [master document: ../jInterp.tex ]

\subsection[title=Symbols]

\startTestSuite[appendSymbols]

\startCCode
char *appendSymbols(Symbol *sym1, Symbol *sym2) {
  char *newSym =
    (char*)calloc(
      strlen(sym1)+strlen(sym2)+1,
      sizeof(char)
    );
  assert(newSym);
  strcpy(newSym, sym1);
  strcat(newSym, sym2);
  return newSym;
}
\stopCCode

\startTestCase[should append two symbols]

\startCTest
  Symbol* newSymb = appendSymbols("prefix-", "-suffix");
  AssertStrEquals(newSymb, "prefix--suffix");
\stopCTest
\stopTestCase
\stopTestSuite

\startCHeader
typedef struct symbol_struct {
  size_t    tag;
  Symbol   *symbol;
  Symbol   *file;
  UInteger  line;
} SymbolObj;

#define isSymbolObj(anObj) ((anObj) && (((JObj*)(anObj))->tag == SymbolTag))
#define asSymbolObj(anObj) ((SymbolObj*)(anObj))
#define asSymbol(anObj)    (((SymbolObj*)(anObj))->symbol)
#define asFile(anObj)      (((SymbolObj*)(anObj))->file)
#define asLine(anObj)      (((SymbolObj*)(anObj))->line)

#define symbolIs(anObj, aSymbol)                \
  (isSymbolObj(anObj) &&                        \
    (strcmp(asSymbol(anObj), (aSymbol)) == 0))
\stopCHeader

\startTestSuite[newSymbol]

\startCHeader
SymbolObj *newSymbol(Symbol *aSymbol, Symbol *aFile, UInteger aLine);
\stopCHeader

\startCCode
SymbolObj *newSymbol(Symbol *aSymbol, Symbol *aFile, UInteger aLine) {
  SymbolObj *newObj =
    (SymbolObj*)calloc(1, sizeof(SymbolObj));
  newObj->tag    = SymbolTag;
  newObj->symbol = strdup(aSymbol);
  newObj->file   = aFile;
  newObj->line   = aLine;
  return newObj;
}
\stopCCode

\startTestCase[should create a new symbol]

\startCTest
  SymbolObj* aSymb = newSymbol("This is a test", "testFile", 42);
  AssertIntTrue(isSymbolObj(aSymb));
  AssertIntEquals(getJObjTag(aSymb), SymbolTag);
  AssertStrEquals(asSymbol(aSymb), "This is a test");
  AssertStrEquals(asFile(aSymb), "testFile");
  AssertIntEquals(asLine(aSymb), 42);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[symbolPrinter]

\startCHeader
void symbolPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
);
\stopCHeader

\startCCode
void symbolPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
) {
  DEBUG(DebugMask, "symbolPrinter %p\n", anObj);
  assert(isSymbolObj(anObj));
  if (indent) {
    strBufPrintf(aStrBuf, "%s%s\n", indent, asSymbol(anObj));
  } else {
    strBufPrintf(aStrBuf, "%s ", asSymbol(anObj));
  }
}
\stopCCode

\startTestCase[should print a symbol]

\startCTest
  SymbolObj *aSymb = newSymbol("This is a test", NULL, 0);
  StringBufferObj *aStrBuf = newStringBuffer();
  symbolPrinter(aStrBuf, asJObj(aSymb), "  ", 20);
  AssertStrMatches(getCString(aStrBuf), "This is a test");
  AssertStrMatches(getCString(aStrBuf), "\n");
  
  strBufReOpen(aStrBuf);
  symbolPrinter(aStrBuf, asJObj(aSymb), NULL, 20);
  AssertStrEquals(getCString(aStrBuf), "This is a test ");
  AssertStrDoesNotMatch(getCString(aStrBuf), "\n");
  
  strBufClose(aStrBuf);
  free(aStrBuf);
\stopCTest

\stopTestCase
\stopTestSuite