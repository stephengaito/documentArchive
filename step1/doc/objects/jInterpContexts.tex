% A ConTeXt document [master document: ../jInterp.tex ]

\subsection[title=Contexts]

\startCHeader
typedef struct symbolTable_struct SymbolTableObj;

typedef struct context_struct {
  size_t          tag;
  JObj           *data;
  JObj           *process;
  JObj           *command;
  Symbol         *name;
  SymbolTableObj *symbolTable;
  Symbol         *text;
  size_t          textSize;
  Boolean         tracingOn;
  Boolean         debug;
  size_t          showDepth;
} ContextObj;

#define isContextObj(anObj) ((anObj) && (((ContextObj*)(anObj))->tag == ContextTag))
#define asContextObj(anObj) ((ContextObj*)(anObj))
#define asCtxName(anObj) (((ContextObj*)(anObj))->name)
#define asCtxData(anObj) (((ContextObj*)(anObj))->data)
#define asCtxProcess(anObj) (((ContextObj*)(anObj))->process)
\stopCHeader


\startTestSuite[newContext]

\startCHeader
ContextObj *newContext(JObj *data, JObj *process, Symbol *name);
\stopCHeader

\startCCode
ContextObj *newContext(JObj *data, JObj *process, Symbol *name) {
  ContextObj *newObj =
    (ContextObj*)calloc(1, sizeof(ContextObj));
  newObj->tag       = ContextTag;
  newObj->data      = data;
  newObj->process   = process;
  newObj->command   = NULL;
  newObj->name      = strdup(name);
  newObj->text      = NULL;
  newObj->textSize  = 0;
  newObj->tracingOn = false;
  newObj->debug     = false;
  return newObj;
}
\stopCCode

\startTestCase[should create a new context]

\startCTest
  JObj *data       = asJObj(newPair(NULL, NULL));
  JObj *process    = asJObj(newPair(NULL, NULL));
  ContextObj* aCtx = newContext(data, process, "TestCtx");
  AssertIntTrue(isContextObj(aCtx));
  AssertIntEquals(getJObjTag(aCtx), ContextTag);
  AssertStrEquals(asCtxName(aCtx), "TestCtx");
  AssertPtrEquals(asCtxData(aCtx), data);
  AssertPtrEquals(asCtxProcess(aCtx), process);
  AssertIntFalse(aCtx->tracingOn);
  AssertIntFalse(aCtx->debug);
  AssertPtrNull(aCtx->command);
\stopCTest
\stopTestCase
\stopTestSuite

\startTestSuite[contextPrinter]

\startCHeader
void contextPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
);
\stopCHeader

\startCCode
void contextPrinter(
  StringBufferObj *aStrBuf,
  JObj            *anObj,
  Symbol          *indent,
  size_t           timeToLive
) {
  DEBUG(DebugMask, "contextPrinter %p\n", anObj);
  assert(isContextObj(anObj));
  if (indent) {
    char *newIndent = appendSymbols(indent, "    ");
    strBufPrintf(aStrBuf, "%s<context:%s>\n", indent, asCtxName(anObj));
    strBufPrintf(aStrBuf, "%s  <data>\n", indent);
    printJObj(aStrBuf, asCtxData(anObj), newIndent, 20);
    strBufPrintf(aStrBuf, "%s  <process>\n", indent);
    printJObj(aStrBuf, asCtxProcess(anObj), newIndent, 20);
    free(newIndent);
  } else {
    strBufPrintf(aStrBuf, "<context:%s ", asCtxName(anObj));
    strBufPrintf(aStrBuf, "  <data: ");
    printJObj(aStrBuf, asCtxData(anObj), NULL, 20);
    strBufPrintf(aStrBuf, "> <process: ");
    printJObj(aStrBuf, asCtxProcess(anObj), NULL, 20);
    strBufPrintf(aStrBuf, "> >");
  }
}
\stopCCode

\startTestCase[should print a context object]

\startCTest
  JObj *data       = asJObj(newPair(NULL, NULL));
  JObj *process    = asJObj(newPair(NULL, NULL));
  ContextObj* aCtx = newContext(data, process, "TestCtx");
  AssertIntTrue(isContextObj(aCtx));
  
  StringBufferObj *aStrBuf = newStringBuffer();
  AssertIntTrue(isStringBufferObj(aStrBuf));
  
  contextPrinter(aStrBuf, asJObj(aCtx), "  ", 20);
  AssertStrMatches(getCString(aStrBuf), "null");
  AssertStrMatches(getCString(aStrBuf), "<context:TestCtx>")
  AssertStrMatches(getCString(aStrBuf), "<data>")
  AssertStrMatches(getCString(aStrBuf), "<process>")
  AssertStrMatches(getCString(aStrBuf), "\n")

  strBufReOpen(aStrBuf);
  contextPrinter(aStrBuf, asJObj(aCtx), NULL, 20);
  AssertStrEquals(getCString(aStrBuf), "<context:TestCtx   <data: (  )  > <process: (  )  > >");
  AssertStrDoesNotMatch(getCString(aStrBuf), "\n");
  
  strBufClose(aStrBuf);
  free(aStrBuf);
\stopCTest
\stopTestCase
\stopTestSuite