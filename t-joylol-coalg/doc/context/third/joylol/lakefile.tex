% A ConTeXt document [master document: literateModules.tex]

\startchapter[title=Lakefile]

We use a slightly updated version of Steve Donovan's Lakefile tool to 
drive the creation of the various files required by any given 
\type{t-literate-modules} managed \ConTeXt\ module. 

\startLakefile
-- A Lua Lakefile

local docDir    = 't-contests/doc/context/third/contests'
local moduleDir = 't-contests/tex/context/third/contests'
local srcFiles = {
  docDir..'/contests.tex',
  docDir..'/overview.tex',
  docDir..'/preamble.tex',
  docDir..'/testSuites.tex',
  docDir..'/mkivTests.tex',
  docDir..'/luaTests.tex',
  docDir..'/cTests.tex',
  docDir..'/lakefile.tex',
  docDir..'/conclusion.tex'
}

local contextDoc = 
  'cd '..docDir..' ; context contests.tex '

local moduleTargets = {
  't-contests.mkiv',
  't-contests.lua',
  't-contests-templates.lua',
  't-contests.h',
  't-contests-cTests.lua'
}

local testExecs = {
  'allCTests'
}

local buildTargets   = { }
local diffTargets    = { }
local installTargets = { }
local testTargets    = { }

for i, aTarget in ipairs(moduleTargets) do

  table.insert(buildTargets, target(
    'build/'..aTarget,
    srcFiles,
    contextDoc
  ))

  table.insert(diffTargets, target(
    'diff-'..aTarget,
    'build/'..aTarget,
    'diff $(DEPENDS) '..moduleDir..'/'..aTarget
  ))

  table.insert(installTargets, target(
    moduleDir..'/'..aTarget,
    'build/'..aTarget,
    'cp $(DEPENDS) $(TARGET)'
  ))
end

for i, anExec in ipairs(testExecs) do

  table.insert(buildTargets, target(
    'build/'..anExec..'.c',
    srcFiles,
    contextDoc
  ))

  c.program{
    'build/'..anExec,
    src=anExec..'.c',
    cdir='build',
    needs='lua5.2'
  }
  
  table.insert(testTargets, target(
    'build/'..anExec..'-results.lua',
    'build/'..anExec,
    './build/'..anExec
  ))
end

table.insert(buildTargets, target(
  'build/lakefile',
  srcFiles,
  contextDoc
))

table.insert(diffTargets, target(
  'diff-lakefile',
  'build/lakefile',
  'diff $(DEPENDS) lakefile'
))

table.insert(installTargets, target(
  'lakefile',
  'build/lakefile',
  'cp $(DEPENDS) $(TARGET)'
))

target('install', installTargets)

target('diff', diffTargets)

target('tests', testTargets)

default(buildTargets)
\stopLakefile

\stopchapter