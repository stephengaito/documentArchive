% A ConTeXt document [master document: joylol.tex] 

\chapter[title=Lua Make System files] 

In this section we add the code required to produce Lua Make System files 
which know how to compile JoyLoL CoAlgebraic extensions as shared 
libraries which can be loaded into a Lua implementation. 

\startMkIVCode
\def\addJoyLoLTargets#1{%
  \directlua{
    thirddata.joyLoLCoAlgs.addJoyLoLTargets('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addJoyLoLTargets(aCodeStream)
  build.existingDirs = build.existingDirs or { }
  tInsert(build.existingDirs, 'build/joylol')
  tInsert(build.existingDirs, 'install')
  tInsert(build.existingDirs, 'install/joylol')
  litProgs.setCodeStream('Lmsfile', aCodeStream)
  litProgs.markCodeOrigin('Lmsfile')
  local lmsfile = {}
  tInsert(lmsfile, "require 'lms.joyLoL'\n")
  tInsert(lmsfile, "joylol.targets{")
  tInsert(lmsfile, "  coAlgs = {")
  for i, aCoAlg in ipairs(build.coAlgsToBuild) do
    tInsert(lmsfile, "    '"..aCoAlg.."',")
  end
  tInsert(lmsfile, "  },")
  tInsert(lmsfile, "  srcFiles = {")
  for i, aSrcFile in ipairs(build.srcTargets) do
    tInsert(lmsfile, "    '"..aSrcFile.."',")
  end
  tInsert(lmsfile, "  },")
  tInsert(lmsfile, "  coAlgLibs = {")
  for i, aCoAlgDependency in ipairs(build.coAlgDependencies) do
    tInsert(lmsfile, "    '"..aCoAlgDependency.."',")
  end
  tInsert(lmsfile, "  },")
  tInsert(lmsfile, "  buildDir = 'build',")
  tInsert(lmsfile, "}")
  litProgs.setPrepend('Lmsfile', aCodeStream, true)
  litProgs.addCode.default('Lmsfile', tConcat(lmsfile, '\n'))
end

coAlgs.addJoyLoLTargets = addJoyLoLTargets
\stopLuaCode
