% A ConTeXt document [master document: joylolCoAlg.tex]

\chapter[title=JoyLoL] 


\section{JoyLoL code environment}

\subsection{Examples}

\subsection{Implementation}

\startMkIVCode
\defineLitProgs
  [JoylolCode]
  [ option=lisp, numbering=line,
    before={\noindent\startLitProgFrame}, after=\stopLitProgFrame
  ]
  
\setLitProgsOriginMarker[JoylolCode][markJoylolCodeOrigin]
\stopMkIVCode

\startLuaCode
local function markJoylolCodeOrigin()
  local codeType       = setDefs(code, 'JoylolCode')
  local codeStream     = setDefs(codeType, 'curCodeStream', 'default')
  codeStream           = setDefs(codeType, codeStream)
  return sFmt(';; from file: %s after line: %s',
    codeStream.fileName,
    toStr(
      mFloor(
        codeStream.startLine/code.lineModulus
      )*code.lineModulus
    )
  )
end

litProgs.markJoylolCodeOrigin = markJoylolCodeOrigin
\stopLuaCode

\startMkIVCode
\def\addCTestJoyLoLCallbacks#1{%
  \directlua{
    thirddata.joylolCoAlgs.addCTestJoyLoLCallbacks('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addCTestJoyLoLCallbacks(aCodeStream)
  local contests      = setDefs(thirddata, 'contests')
  local tests         = setDefs(contests, 'tests')
  local methods       = setDefs(tests, 'methods')
  local setup         = setDefs(methods, 'setup')
  local cTests        = setDefs(setup, 'cTests')
  aCodeStream         = aCodeStream         or 'default'
  cTests[aCodeStream] = cTests[aCodeStream] or { }
  tInsert(cTests[aCodeStream], [=[
void ctestsWriteStdOut(
  JoyLoLInterp *jInterp,
  Symbol       *aMessage
) {
  fprintf(stdout, "%s", aMessage);
}

void ctestsWriteStdErr(
  JoyLoLInterp *jInterp,
  Symbol       *aMessage
) {
  fprintf(stderr, "%s", aMessage);
}
void *ctestsCallback(
  lua_State *lstate,
  size_t resourceId
) {
  if (resourceId == JoyLoLCallback_StdOutMethod) {
    return (void*)ctestsWriteStdOut;
  } else if (resourceId == JoyLoLCallback_StdErrMethod) {
    return (void*)ctestsWriteStdErr;
  } else if (resourceId == JoyLoLCallback_Verbose) {
    return (void*)FALSE;
  } else if (resourceId == JoyLoLCallback_Debug) {
    return (void*)FALSE;
  }
  return NULL;
} 
]=])
  setup               = setDefs(tests, 'setup')
  cTests              = setDefs(setup, 'cTests')
  cTests[aCodeStream] = cTests[aCodeStream] or { }
  tInsert(cTests[aCodeStream], [=[
setJoyLoLCallbackFrom(lstate, ctestsCallback);
]=])
end

coAlgs.addCTestJoyLoLCallbacks = addCTestJoyLoLCallbacks
\stopLuaCode