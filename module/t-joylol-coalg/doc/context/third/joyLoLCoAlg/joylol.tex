% A ConTeXt document [master document: joylolCoAlg.tex]

\chapter[title=JoyLoL] 

QUESTION: How do we load a *.joy file? Where do we put this command?

\section{JoyLoL code environment}

\subsection{Examples}

\subsection{Implementation}

\startMkIVCode
\defineLitProgs
  [JoylolCode]
  [ option=lisp, numbering=line,
    before={\noindent\startLitProgFrame}, after=\stopLitProgFrame
  ]
  
\setLitProgsOriginMarker[JoylolCode][markJoylolCodeOrigin]
\stopMkIVCode

\startLuaCode
local function markJoylolCodeOrigin()
  local codeType       = setDefs(code, 'JoylolCode')
  local codeStream     = setDefs(codeType, 'curCodeStream', 'default')
  codeStream           = setDefs(codeType, codeStream)
  return sFmt(';; from file: %s after line: %s',
    codeStream.fileName,
    toStr(
      mFloor(
        codeStream.startLine/code.lineModulus
      )*code.lineModulus
    )
  )
end

litProgs.markJoylolCodeOrigin = markJoylolCodeOrigin
\stopLuaCode

\section[title=Lua Make System files] 

In this section we add the code required to produce Lua Make System files 
which know how to compile JoyLoL CoAlgebraic extensions as shared 
libraries which can be loaded into a Lua implementation. 

\startMkIVCode
\def\addJoyLoLTargets#1{%
  \directlua{
    thirddata.joylolCoAlgs.addJoyLoLTargets('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addJoyLoLTargets(aCodeStream)
  litProgs.setCodeStream('Lmsfile', aCodeStream)
  litProgs.markCodeOrigin('Lmsfile')
  local lmsfile = {}
  tInsert(lmsfile, "require 'lms.joyLoL'\n")
  tInsert(lmsfile, "joylol.targets(lpTargets, {")
  tInsert(lmsfile, "  coAlgs = {")
  for i, aCoAlg in ipairs(build.coAlgsToBuild) do
    tInsert(lmsfile, "    '"..aCoAlg.."',")
  end
  tInsert(lmsfile, "  },")
  
  build.srcTargets = build.srcTargets or { }
  local srcTargets = build.srcTargets
  
  srcTargets.cHeader = srcTargets.cHeader or { }
  local cHeader      = srcTargets.cHeader
  tInsert(lmsfile, "  cHeaderFiles = {")
  for i, aSrcFile in ipairs(cHeader) do
    tInsert(lmsfile, "    '"..aSrcFile.."',")
  end
  tInsert(lmsfile, "  },")
  
  srcTargets.cCode = srcTargets.cCode or { }
  local cCode      = srcTargets.cCode
  tInsert(lmsfile, "  cCodeFiles = {")
  for i, aSrcFile in ipairs(cCode) do
    tInsert(lmsfile, "    '"..aSrcFile.."',")
  end
  tInsert(lmsfile, "  },")

  if build.cCodeLibDirs then 
    tInsert(lmsfile, "  cCodeLibDirs = {")
    for i, aLibDir in ipairs(build.cCodeLibDirs) do
      tInsert(lmsfile, "    '"..aLibDir.."',")
    end
    tInsert(lmsfile, "  },")
  end
  if build.cCodeLibs then 
    tInsert(lmsfile, "  cCodeLibs = {")
    for i, aLib in ipairs(build.cCodeLibs) do
      tInsert(lmsfile, "    '"..aLib.."',")
    end
    tInsert(lmsfile, "  },")
  end

  tInsert(lmsfile, "  coAlgLibs = {")
  for i, aCoAlgDependency in ipairs(build.coAlgDependencies) do
    tInsert(lmsfile, "    '"..aCoAlgDependency.."',")
  end
  tInsert(lmsfile, "  },")
  tInsert(lmsfile, "})")
  litProgs.setPrepend('Lmsfile', aCodeStream, true)
  litProgs.addCode.default('Lmsfile', tConcat(lmsfile, '\n'))
end

coAlgs.addJoyLoLTargets = addJoyLoLTargets
\stopLuaCode
