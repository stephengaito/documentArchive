% A ConTeXt document [master document: joylolTests.tex]

\section[title=Words]

\startTestSuite[start/stop joylol all tests]

\setJoylolTracingOff\setJoylolVerboseOff

We start by defining a naming scope to contain all of the Joylol test 
associated words. This naming space is denoted \quote{tests} in the 
\quote{globals} naming scope. The \quote{tests} naming scope's parent 
naming scope is also \quote{globals}. 

\startJoylolCode
;; create a tests naming scope
globals      ;; parent naming scope
globals      ;; defining naming scope
tests        ;; defined name of this new naming scope
defineNaming ;; make the definition
\stopJoylolCode

We also create a naming scope to contain all of the assertion related 
words. 

\startJoylolCode
;; create an assert naming scope
tests        ;; parent naming scope
globals      ;; defining naming scope
assert       ;; defined name of this new naming scope
defineNaming ;; make the definition
\stopJoylolCode

Our next task, over the next following code fragments, is to define the 
runTestCase word. This word takes a test case, as a list of the words to 
be tested intermingled with assertions, and creates the testMonitor and 
testRunner contexts which together run the test case provided. To be 
completely re-entrant, the testMonitor and testRunner contexts are stored 
in the running context's localized naming scope. 

\startJoylolCode
(               ;; start of the runTestCase word
\stopJoylolCode

We start by localizing the running context's naming scope and then 
defining the testRunnerNS and testMonitorNS naming scopes in the localized 
naming scope. 

\startJoylolCode
  ;; localize the naming scope of the current context
  locals
  localizeNaming
\stopJoylolCode

\startJoylolCode
  ;; create the testRunnerNS
  globals      ;; parent naming scope
  thisNaming   ;; define in localized naming scope
  testRunnerNS ;; name of the new naming scope
  defineNaming ;; create a new naming scope
               ;; to be used as the testRunner's naming scope
\stopJoylolCode

\startJoylolCode
  ;; create the testMonitorNS
  globals       ;; parent naming scope
  thisNaming    ;; define in the localized naming scope
  testMonitorNS ;; name of the new naming scope
  defineNaming  ;; create a new naming scope
                ;; to be used as the testMonitor's naming scope
\stopJoylolCode

At this point the test case's list of words and assertions are back on the 
top of the stack. This list will be used as the testRunner's initial 
process stack. We can now add the initial data stack for the testRunner 
context, and then setup the new context's naming scope, the defining 
naming scope and finally the name of the new context.

\startJoylolCode
  ;; define the testRunner context
                ;; testRunner process (uses provided list of words)
  ( 
  )             ;; testRunner data
  testRunnerNS  ;; the naming scope of the new context
  thisNaming    ;; define in the localized naming scope
  testRunner    ;; name of the new context
  defineContext ;; create and define the context
\stopJoylolCode

Now we create a testMonitor context which will keep track of the test 
results. The testMonitor's initial process stack should contain the three 
words, \type{interpret}, the current context, and \type{switch} in this 
order. When an assertion switches from the testRunner's context to the 
testMonitor context the top of the testRunner's stack is place onto the 
top of the testMonitor's data stack. The \type{interpret} word will then 
place the words on the top of the testMonitor's data stack onto the 
testMonitor's process stack to be interpreted. The assertion being 
interpreted \emph{should} ensure it re-places the \type{interpret} word 
back on the testMonitor's process stack for use by the next assertion. 

The last two words, the current context and \type{switch}, as used by the 
textMonitor interpreting the \type{results} word to know which context to 
switch to with the summary results. 

Since the \type{thisContext} word has to be interpreted in the calling 
context, we have to \type{append} the result of interpreting the 
\type{thisContext} word rather than just placing the \type{thisContext} 
word directly on the testMonitor's process stack. Once the 

\startJoylolCode
  ;; define the testMonitor context
  ( interpret ) ;; begin the testMonitor process stack
  thisContext   ;; interpret thisContext 
  append        ;; append the result of interpreting thisContext
  ( switch )    ;; 
  append        ;; append the word switch to the
                ;; testMonitor's initial process stack
  
  ( 
    0           ;; number of attempted tests
    0           ;; number of failed tests
    ()          ;; list of failure reports
  )             ;; testMonitor data

  testMonitorNS ;; the naming scope of the new context
  thisNaming    ;; defining naming scope
  testMonitor   ;; defined name of this new context
  defineContext ;; create and define the context
\stopJoylolCode

Finally we switch to the testRunner context.

\startJoylolCode
  ;; switch to the testRunner context and run the tests
  testRunner ;; place the testRunner context on the stack
  switch     ;; switch to the testRunner context
  
)            ;; end of the runTestCase definition

tests        ;; define the new word in this naming scope
runTestCase  ;; the name of the new word
define       ;; define the new runTestCase word
\stopJoylolCode

\startJoylolCode
testRunner ;;
testMonitorNS ;;
(
  testRunner
) extract
define

testMonitor ;;
testRunnerNS ;;
(
  testMonitor
) extract
define


\stopJoylolCode


\stopTestSuite

\starttyping
\startTestSuite[start/stop joylol test suite]

\startJoylolCode
  (
  )
  startTestSuite
  define
  
  (
  )
  stopTestSuite
  define
\stopJoylolCode

\stopTestSuite
\stoptyping

\startTestSuite[start/stop/skip/run a joylol test case]

\startJoylolCode
(
  ( interpret ) ;; process
  (
    true ;; test case successful
    false ;; test case should fail
  ) ;; data
  tests
  curTestCase
  defineContext
)
tests
runTestCase
define
\stopJoylolCode

\stopTestSuite

\startTestSuite[reportTestResult]

\startJoylolCode
  (
  )
  reportTestResult
  define
\stopJoylolCode

\stopTestSuite

\startTestSuite[assertShouldFail]

\startJoylolCode

(
  
)
tests
assertShouldFail
define
\stopJoylolCode

\startTestCase[assert should fail]
\startJoylolTest
"this is a test"
doSomeThing
\stopJoylolTest
\stopTestCase
\stopTestSuite

\startTestSuite[assertFail]

\startJoylolCode
(
)
tests
assertFail
define
\stopJoylolCode

\startTestCase[assertFail should fail]
\startJoylolTest
assertFail
\stopJoylolTest
\stopTestCase
\stopTestSuite

\startTestSuite[assertSucceed]

\stopTestSuite

\startTestSuite[assertTrue]

\stopTestSuite

\startTestSuite[assertFalse]

\stopTestSuite

\startTestSuite[assertNil]

\stopTestSuite

\startTestSuite[assertNotNil]

\stopTestSuite

\startTestSuite[assertAtom]

\stopTestSuite

\startTestSuite[assertPair]

\stopTestSuite

\startTestSuite[assertNatural]

\stopTestSuite

\startTestSuite[assertSymbol]

\stopTestSuite

\startTestSuite[assertContext]

\stopTestSuite

\startTestSuite[assertDictionary]

\stopTestSuite

\startTestSuite[assertDictNode]

\stopTestSuite


\setCHeaderStream{private}
\startCHeader
extern void registerJoylolTestWords(
  JoyLoLInterp* jInterp
);
\stopCHeader
\setCHeaderStream{public}

\startCCode
void registerJoylolTestWords(
  JoyLoLInterp* jInterp
) {
  assert(jInterp);

}
\stopCCode