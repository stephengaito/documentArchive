% A ConTeXt document [master document: coreLua.tex]

\chapter[title=Lua main]

\prependLuaCode{default}

\component gitVersion-lua

\startLuaCode
-- joylol command line interpreter 

-- Start by adding the standard joylol CoAlg locations to
-- the Lua search paths 

local joylolPaths = {
  os.getenv('HOME')..'/.joylol/?.lua',
  '/usr/local/lib/joylol/?.lua',
  '/usr/lib/joylol/?.lua',
  package.path
}
package.path = table.concat(joylolPaths, ';')

local joylolCPaths = {
  os.getenv('HOME')..'/.joylol/?.so',
  '/usr/local/lib/joylol/?.so',
  '/usr/lib/joylol/?.so',
  package.path
}
package.cpath = table.concat(joylolCPaths, ';')

joylol = { }
joylol.options = { }
local options = joylol.options

argStr = '|'..table.concat(arg, '|')..'|'
joylol.options.verbose = argStr:match('|%-v|');
joylol.options.debug   = argStr:match('|%-d|');

if verbose then print('loading [joylol.core.lua]') end
joylol = require 'joylol.core.lua'
if verbose then print('loaded [joylol.core.lua]\n') end

joylol.options = options

helpText = {
  "usage: joylol [options] [files to load]",
  "",
  "options: ",
  " -h --help        prints this help text and exits",
  " -i --ignore      ignores default configuration file (~.joylol)",
  " -l --load <file> loads the file <file>",
  " -p --path <path> adds <path> to the list of load paths",
  " -q --quiet       toggles verbose off",
  " -v --verbose     toggles verbose on",
  " -d --debug       turns on internal debugging",
  "",
  "files to load:",
  "  Any remaining options are treated as files to be loaded.",
  "  If there are no remaining options, joylol enters the read,",
  "  eval, print loop."
}

loadConfiguration = true
loadFiles         = { }
  
while(0 < #arg) do
  anArg = table.remove(arg, 1)
  if anArg:match('-h') then
    print(table.concat(helpText, '\n'))
    os.exit(0);
  elseif anArg:match('-i') then
    loadConfiguration = false
  elseif anArg:match('-l') then
    optArg = table.remove(arg, 1)
    table.insert(loadFiles, optArg)
  elseif anArg:match('-p') then
    optArg = table.remove(arg, 1)
    joylol.core.lua.pushLoadPath(optArg)
  elseif anArg:match('-q') then
    joylol.core.lua.setVerbose(false)
    joylol.core.lua.setDebugging(false)
  elseif anArg:match('-v') then
    joylol.core.lua.setVerbose(true)
  elseif anArg:match('-d') then
    joylol.core.lua.setDebugging(true)
  else
    optArg = table.remove(arg, 1)
    table.insert(loadFiles, optArg)
  end
end

if (loadConfiguration) then
  joylol.core.lua.loadFile("config")
end

for i, aFile in ipairs(loadFiles) do
  joylol.core.lua.loadFile(aFile)
end

joylol.core.lua.runREPL();

\stopLuaCode