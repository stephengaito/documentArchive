% A ConTeXt document [master document: joylol.tex]

\chapter[title=Lua main]

\prependLuaCode{default}

\component gitVersion-lua

\startLuaCode
-- joylol interpreter embedded in ConTeXt

-- Start by adding the standard joylol CoAlg locations to the Lua search 
-- paths 

local joylolPaths = {
  os.getenv('HOME')..'/.joylol/?.lua',
  '/usr/local/lib/joylol/?.lua',
  '/usr/lib/joylol/?.lua',
  package.path
}
package.path = table.concat(joylolPaths, ';')

local joylolCPaths = {
  os.getenv('HOME')..'/.joylol/?.so',
  '/usr/local/lib/joylol/?.so',
  '/usr/lib/joylol/?.so',
  package.path
}
package.cpath = table.concat(joylolCPaths, ';')

-- argStr = '|'..table.concat(arg, '|')..'|'
-- verbose = argStr:match('|%-v|');

-- if verbose then print('loading [joylol.core.context]') end
-- thirddata.joylol = require 'joylol.core.context'
-- if verbose then print('loaded [joylol.core.context]\n') end

loadConfiguration = true
  
while(0 < #arg) do
  anArg = table.remove(arg, 1)
  if anArg:match('-h') then
    print(table.concat(helpText, '\n'))
    os.exit(0);
  elseif anArg:match('-i') then
    loadConfiguration = false
  elseif anArg:match('-q') then
    joylol.core.lua.setVerbose(false)
  elseif anArg:match('-v') then
    joylol.core.lua.setVerbose(true)
  else
    optArg = table.remove(arg, 1)
    table.insert(loadFiles, optArg)
  end
end

if (loadConfiguration) then
--  joylol.core.lua.loadFile("config")
end

\stopLuaCode

\startMkIVCode
\def\loadJoyLoLFile#1{%
  \directlua{%
    thirddata.joylol.loadFile('#1')
  }
}

\def\pushJoyLoLLoadPath#1{%
  \directlua{%
    thirddata.joylol.pushLoadPath('#1')
  }
}


\stopMkIVCode