% A ConTeXt document [master document: coreContext.tex]

\chapter[title=Lua main]

\prependLuaCode{default}

\component gitVersion-lua

\startLuaCode
-- joylol interpreter embedded in ConTeXt

-- Start by adding the standard joylol CoAlg locations to the Lua search 
-- paths 

texio.write_nl("----------JoyLoL options-----------")
texio.write_nl(prettyPrint(options))
texio.write_nl("-----------------------------------")

local joylolPaths = {
  options.userPath..'/?.lua',
  options.localPath..'/?.lua',
  options.systemPath..'/?.lua',
  package.path
}
package.path = table.concat(joylolPaths, ';')

local joylolCPaths = {
  options.userPath..'/?.so',
  options.localPath..'/?.so',
  options.systemPath..'/?.so',
  package.path
}
package.cpath = table.concat(joylolCPaths, ';')

if options.verbose then print('loading [joylol.core.context]') end

-- **Problem**: we can not assume that a user *has*
-- a compiled and working C based JoyLoL. This is 
-- the "Bootstrapping (Compiler)" problem (see 
-- Wikipedia). We solve this problem by writing a
-- minimal joyLoL interpreter in Lua. 

-- SO if the user has requested to load the ANSI-C 
-- version of JoyLoL then we first check to see if
-- the joyLoL (C shared libraries) exists and can be
-- required, if it can not be loaded, we load the
-- joyLoLMinLua version instead.

-- If the user has not requested to load the ANSI-C
-- version of JoyLoL then we simply load the Lua based
-- joyLoLMinLua version.

-- The following conditional require is adapted 
-- from: shuva's answer to 
--   "How to check if a module exists in Lua?"
-- see: http://stackoverflow.com/a/22686090

if options.minimalJoylol then
  interfaces.writestatus("joyLoL", 
    "Loading MINIMAL Lua version as requested.")
  lua.registercode('t-joylol-minimal')
  loadedJoylol = thirddata.minJoylol
  thirddata.joylol = loadedJoylol
else
  local hasJoylol, loadedJoylol = 
    pcall(require, 'joylol.core.context')
  if not hasJoylol then
    interfaces.writestatus("joyLoL", 
      "Could NOT load ANSI-C joyLoL... loading mininal Lua version instead.")
    lua.registercode('t-joylol-minimal')
    loadedJoylol = thirddata.minJoylol
  else
    interfaces.writestatus("joyLoL", 
      "Loaded ANSI-C version as requested.")
  end
  thirddata.joylol = loadedJoylol
end

if options.verbose then print('loaded [joylol.core.context]\n') end

local joylol = thirddata.joylol

joylol.core.context.setVerbose(options.verbose)
joylol.core.context.setDebugging(options.debug)

if (options.configFile) then
  joylol.core.context.loadFile(options.configFile)
end

\stopLuaCode
